<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> mybatis pageHelper插件研究 | Rosy's</title><meta name="description" content="mybatis pageHelper插件研究 - Rosy"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/casual.css"><link rel="stylesheet" href="/css/semantic.min.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="Rosy's"></head><body><div class="sidebar"><div class="ui vertical inverted menu"><div class="h100"></div><h3 class="ui inverted aligned icon header"><div class="content"><a href="/" class="title-link">ROSY'S</a></div></h3><div class="h50"></div><div class="side-nav"><a href="/" target="_self" class="item">HOME<i class="icon home"></i></a><a href="/archives" target="_self" class="item">ARCHIVE<i class="icon archive"></i></a><a href="/tags" target="_self" class="item">TAGS<i class="icon tags"></i></a><a href="/about" target="_self" class="item">INFO<i class="icon info"></i></a><a href="/atom.xml" target="_self" class="item">RSS<i class="icon rss"></i></a></div><div class="item"><div class="ui inverted transparent icon input"><input type="text" placeholder="Search..." class="st-default-search-input"><i class="search icon"></i></div></div><div class="h50"></div></div><div class="h50 mq"><a class="ui teal big label"><i class="content icon"></i></a></div><div class="author-info"><a href="/" class="img-link"><img src="/me.jpeg" class="author-photo ui tiny circular image"></a><h4 class="ui aligned icon header"><div class="content">Rosy</div></h4><p class="author-desc">常常将自己分裂成三个人用于玩斗地主的双子女 | 热衷于烹饪 | 喜欢刘亦菲</p><div class="social-outer"><div class="social-inner"><a href="http://github.com/RanWX" target="_blank" class="social-link"><i class="icon github"></i></a><a href="http://weibo.com/u/2176147782?refer_flag=1005055010_&amp;is_all=1" target="_blank" class="social-link"><i class="icon weibo"></i></a></div></div></div></div><div class="main"><div class="wrap"><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">mybatis pageHelper插件研究</h1><div class="post-info"><div class="post-date"><h6 class="ui header"><i class="calendar icon"></i><div class="content">Jul 31, 2018</div></h6></div></div><div class="post-content"><h2 id="1-mybatis插件"><a href="#1-mybatis插件" class="headerlink" title="1. mybatis插件"></a>1. mybatis插件</h2><p>在mybatis中使用插件，需要先实现接口Interceptor：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">public interface Interceptor &#123;</div><div class="line"></div><div class="line">  Object intercept(Invocation invocation) throws Throwable;</div><div class="line"></div><div class="line">  Object plugin(Object target);</div><div class="line"></div><div class="line">  void setProperties(Properties properties);</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Interceptor中有三个方法：</p>
<ul>
<li>intercept方法：是插件的核心方法，它将直接覆盖你所拦截的对象原有的方法。intercept里有个参数Invocation对象，通过它可以反射调度原料对象的方法。</li>
<li>plugin方法：target是被拦截对象，plugin方法的作用是给被拦截对象生成一个代理对象并返回。</li>
<li>setProperties方法：允许在plugin中配置所需要的参数，该方法在插件初始化的时候就被调用一次，然后把插件对象存到配置中，以便后续取出。</li>
</ul>
<h2 id="2-PageHelper"><a href="#2-PageHelper" class="headerlink" title="2. PageHelper"></a>2. PageHelper</h2><p>PageHelper会使用ThreadLocal获取到同一线程中的变量信息，各个线程之间的Threadlocal不会相互干扰，也就是Thread1中的ThreadLocal1之后获取到Tread1中的变量的信息，不会获取到Thread2中的信息所以在多线程环境下，各个Threadlocal之间相互隔离，可以实现，不同thread使用不同的数据源或不同的Thread中执行不同的SQL语句，所以，PageHelper利用这一点通过拦截器获取到同一线程中的预编译好的SQL语句之后将SQL语句包装成具有分页功能的SQL语句，并将其再次赋值给下一步操作，所以实际执行的SQL语句就是有了分页功能的SQL语句。</p>
<p>startPage源码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * 开始分页</div><div class="line"> *</div><div class="line"> * @param pageNum  页码</div><div class="line"> * @param pageSize 每页显示数量</div><div class="line"> * @param count    是否进行count查询</div><div class="line"> */</div><div class="line">public static Page startPage(int pageNum, int pageSize, boolean count) &#123;</div><div class="line">    return startPage(pageNum, pageSize, count, null);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最终执行的代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">public static Page startPage(int pageNum, int pageSize, boolean count, Boolean reasonable, Boolean pageSizeZero) &#123;</div><div class="line">    Page page = new Page(pageNum, pageSize, count);</div><div class="line">    page.setReasonable(reasonable);</div><div class="line">    page.setPageSizeZero(pageSizeZero);</div><div class="line">    SqlUtil.setLocalPage(page);</div><div class="line">    return page;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其中SqlUtil.setLocalPage是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">public static void setLocalPage(Page page) &#123;</div><div class="line">    LOCAL_PAGE.set(page);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>LOCAL_PAGE是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">private static final ThreadLocal&lt;Page&gt; LOCAL_PAGE = new ThreadLocal&lt;Page&gt;();</div></pre></td></tr></table></figure>
<p>PageHelper就是使用ThreadLocal存储了Page对象，在这个对象中有我们设置的pageNum、pageSize，也会查询返回的pages、total。</p>
<h2 id="3-PageHelper执行过程"><a href="#3-PageHelper执行过程" class="headerlink" title="3. PageHelper执行过程"></a>3. PageHelper执行过程</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Page page = PageHelper.startPage(pageNumber, pageSize, true);</div></pre></td></tr></table></figure>
<p>配置好PageHelper后，在代码中使用PageHelper后，LOCAL_PAGE会存入分页信息。</p>
<p>在PageHelper下的第一个查询的方法会被PageHelper拦截住，然后重新组装sql语句。具体组装的源码为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div></pre></td><td class="code"><pre><div class="line">private Object _processPage(Invocation invocation) throws Throwable &#123;</div><div class="line">    final Object[] args = invocation.getArgs();</div><div class="line">    RowBounds rowBounds = (RowBounds) args[2];</div><div class="line">    if (SqlUtil.getLocalPage() == null &amp;&amp; rowBounds == RowBounds.DEFAULT) &#123;</div><div class="line">        if (OrderByHelper.getOrderBy() != null) &#123;</div><div class="line">            OrderByHelper.processIntercept(invocation);</div><div class="line">        &#125;</div><div class="line">        return invocation.proceed();</div><div class="line">    &#125; else &#123;</div><div class="line">        //获取原始的ms</div><div class="line">        MappedStatement ms = (MappedStatement) args[0];</div><div class="line">        //判断并处理为PageSqlSource</div><div class="line">        if (!isPageSqlSource(ms)) &#123;</div><div class="line">            processMappedStatement(ms, parser);</div><div class="line">        &#125;</div><div class="line">        //忽略RowBounds-否则会进行Mybatis自带的内存分页</div><div class="line">        args[2] = RowBounds.DEFAULT;</div><div class="line">        //分页信息</div><div class="line">        Page page = getPage(rowBounds);</div><div class="line">        //pageSizeZero的判断</div><div class="line">        if ((page.getPageSizeZero() != null &amp;&amp; page.getPageSizeZero()) &amp;&amp; page.getPageSize() == 0) &#123;</div><div class="line">            COUNT.set(null);</div><div class="line">            //执行正常（不分页）查询</div><div class="line">            Object result = invocation.proceed();</div><div class="line">            //得到处理结果</div><div class="line">            page.addAll((List) result);</div><div class="line">            //相当于查询第一页</div><div class="line">            page.setPageNum(1);</div><div class="line">            //这种情况相当于pageSize=total</div><div class="line">            page.setPageSize(page.size());</div><div class="line">            //仍然要设置total</div><div class="line">            page.setTotal(page.size());</div><div class="line">            //返回结果仍然为Page类型 - 便于后面对接收类型的统一处理</div><div class="line">            return page;</div><div class="line">        &#125;</div><div class="line">        //简单的通过total的值来判断是否进行count查询</div><div class="line">        if (page.isCount()) &#123;</div><div class="line">            COUNT.set(Boolean.TRUE);</div><div class="line">            //替换MS</div><div class="line">            args[0] = msCountMap.get(ms.getId());</div><div class="line">            //查询总数</div><div class="line">            Object result = invocation.proceed();</div><div class="line">            //还原ms</div><div class="line">            args[0] = ms;</div><div class="line">            //设置总数</div><div class="line">            page.setTotal((Integer) ((List) result).get(0));</div><div class="line">            if (page.getTotal() == 0) &#123;</div><div class="line">                return page;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        //pageSize&gt;0的时候执行分页查询，pageSize&lt;=0的时候不执行相当于可能只返回了一个count</div><div class="line">        if (page.getPageSize() &gt; 0 &amp;&amp;</div><div class="line">                ((rowBounds == RowBounds.DEFAULT &amp;&amp; page.getPageNum() &gt; 0)</div><div class="line">                        || rowBounds != RowBounds.DEFAULT)) &#123;</div><div class="line">            //将参数中的MappedStatement替换为新的qs</div><div class="line">            COUNT.set(null);</div><div class="line">            BoundSql boundSql = ms.getBoundSql(args[1]);</div><div class="line">            args[1] = parser.setPageParameter(ms, args[1], boundSql, page);</div><div class="line">            COUNT.set(Boolean.FALSE);</div><div class="line">            //执行分页查询</div><div class="line">            Object result = invocation.proceed();</div><div class="line">            //得到处理结果</div><div class="line">            page.addAll((List) result);</div><div class="line">        &#125;</div><div class="line">        //返回结果</div><div class="line">        return page;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在实际查询中打印出sql为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">ooo Using Connection [com.alibaba.druid.proxy.jdbc.ConnectionProxyImpl@25428560]</div><div class="line">==&gt;  Preparing: SELECT count(*) FROM translator t LEFT JOIN account a ON a.translator_id = t.id AND a.delete_flag = 1 WHERE t.delete_flag = 1 AND t.account_status != 0 AND t.account_status != 3 </div><div class="line">==&gt; Parameters: </div><div class="line">&lt;==    Columns: count(*)</div><div class="line">&lt;==        Row: 5</div><div class="line">&lt;==      Total: 1</div><div class="line">ooo Using Connection [com.alibaba.druid.proxy.jdbc.ConnectionProxyImpl@25428560]</div><div class="line">==&gt;  Preparing: SELECT a.name as name, a.account_id as account_id, a.nick_name as nick_name, t.sex as sex, a.phone_number as phone_number, t.id as id, t.translator_level as translator_level, t.account_status as account_status FROM translator t LEFT JOIN account a on a.translator_id= t.id AND a.delete_flag = 1 WHERE t.delete_flag = 1 and t.account_status != 0 and t.account_status != 3 limit ?,? </div><div class="line">==&gt; Parameters: 0(Integer), 3(Integer)</div><div class="line">&lt;==    Columns: name, account_id, nick_name, sex, phone_number, id, translator_level, account_status</div><div class="line">&lt;==        Row: 121212@163.com, 1, 王五, 0, 13310101001, 1, null, 4</div><div class="line">&lt;==        Row: 222222@qq.com, 9, 张三, 1, 18811221122, 2, null, 4</div><div class="line">&lt;==        Row: lisi, 12, lisi, 0, 13899988223, 4, 1, 4</div><div class="line">&lt;==      Total: 3</div></pre></td></tr></table></figure>
<p>不加PageHelper打印出的sql为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">ooo Using Connection [com.alibaba.druid.proxy.jdbc.ConnectionProxyImpl@30e836ca]</div><div class="line">==&gt;  Preparing: SELECT a.name as name, a.account_id as account_id, a.nick_name as nick_name, t.sex as sex, a.phone_number as phone_number, t.id as id, t.translator_level as translator_level, t.account_status as account_status FROM translator t LEFT JOIN account a on a.translator_id= t.id AND a.delete_flag = 1 WHERE t.delete_flag = 1 and t.account_status != 0 and t.account_status != 3 </div><div class="line">==&gt; Parameters: </div><div class="line">&lt;==    Columns: name, account_id, nick_name, sex, phone_number, id, translator_level, account_status</div><div class="line">&lt;==        Row: 121212@163.com, 1, 王五, 0, 13310101001, 1, null, 4</div><div class="line">&lt;==        Row: 222222@qq.com, 9, 张三, 1, 18811221122, 2, null, 4</div><div class="line">&lt;==        Row: lisi, 12, lisi, 0, 13899988223, 4, 1, 4</div><div class="line">&lt;==        Row: wangmazi, 15, wangmazi, 0, 17722818182, 18, null, 1</div><div class="line">&lt;==        Row: xiaohua, 14, xiaohua, 1, 16322818182, 19, 0, 4</div><div class="line">&lt;==      Total: 5</div></pre></td></tr></table></figure></div></article></div></section><footer><div class="paginator"><a href="/2018/07/31/hibernate实体类与数据库表的常见映射/" class="prev"><button class="ui button teal">PREV</button></a><a href="/2018/07/31/hibernate和mybatis查询对比/" class="next"><button class="ui button teal">NEXT</button></a></div><div class="copyright"><p>© 2016 - 2019 <a href="http://yoursite.com">Rosy</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and theme by <a href="https://github.com/littlewin-wang/hexo-theme-casual" target="_blank">casual</a></p></div></footer></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script><script src="/js/jquery.goup.min.js"></script><script src="/js/semantic.min.js"></script><script src="/js/casual.js"></script><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>$(document).ready(function(){$.goup({trigger:100,bottomOffset:100,locationOffset:5,title:'',titleAsText:true});});</script><script>(function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){(w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);})(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');
_st('install','TvAnFS4AVxjiJUvrZJRB','2.0.0');</script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></div></body></html>