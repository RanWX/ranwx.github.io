<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> jpa联表查询对子表进行crud操作 | Rosy's</title><meta name="description" content="jpa联表查询对子表进行crud操作 - Rosy"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/casual.css"><link rel="stylesheet" href="/css/semantic.min.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="Rosy's"></head><body><div class="sidebar"><div class="ui vertical inverted menu"><div class="h100"></div><h3 class="ui inverted aligned icon header"><div class="content"><a href="/" class="title-link">ROSY'S</a></div></h3><div class="h50"></div><div class="side-nav"><a href="/" target="_self" class="item">HOME<i class="icon home"></i></a><a href="/archives" target="_self" class="item">ARCHIVE<i class="icon archive"></i></a><a href="/tags" target="_self" class="item">TAGS<i class="icon tags"></i></a><a href="/about" target="_self" class="item">INFO<i class="icon info"></i></a><a href="/atom.xml" target="_self" class="item">RSS<i class="icon rss"></i></a></div><div class="item"><div class="ui inverted transparent icon input"><input type="text" placeholder="Search..." class="st-default-search-input"><i class="search icon"></i></div></div><div class="h50"></div></div><div class="h50 mq"><a class="ui teal big label"><i class="content icon"></i></a></div><div class="author-info"><a href="/" class="img-link"><img src="/me.jpeg" class="author-photo ui tiny circular image"></a><h4 class="ui aligned icon header"><div class="content">Rosy</div></h4><p class="author-desc">常常将自己分裂成三个人用于玩斗地主的双子女 | 热衷于烹饪 | 喜欢刘亦菲</p><div class="social-outer"><div class="social-inner"><a href="http://github.com/RanWX" target="_blank" class="social-link"><i class="icon github"></i></a><a href="http://weibo.com/u/2176147782?refer_flag=1005055010_&amp;is_all=1" target="_blank" class="social-link"><i class="icon weibo"></i></a></div></div></div></div><div class="main"><div class="wrap"><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">jpa联表查询对子表进行crud操作</h1><div class="post-info"><div class="post-date"><h6 class="ui header"><i class="calendar icon"></i><div class="content">Mar 13, 2018</div></h6></div></div><div class="post-content"><p>jpa使用@OneToMany注解进行两个表之间一对多的关联以方便级联查询。当需要对关联的表进行增删改操作的时候，需要根据实际需求选择合适的方法。</p>
<p>order表的模型，省略get和set。其中order和installment是一对多关系</p>
<p>Order.java<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">@Entity</div><div class="line">@Table(name = &quot;order&quot;)</div><div class="line">@NamedQuery(name = &quot;Order.findAll&quot;, query = &quot;SELECT o FROM Order o&quot;)</div><div class="line">public class Order extends AbstractModel &#123;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * 主键</div><div class="line">     */</div><div class="line">    @Id</div><div class="line">    @GeneratedValue(strategy = GenerationType.IDENTITY)</div><div class="line">    private Long id;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * 订单号</div><div class="line">     */</div><div class="line">    @Column(name = &quot;order_number&quot;)</div><div class="line">    private String orderNumber;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * 总价</div><div class="line">     */</div><div class="line">    @Column(name = &quot;quoted_price&quot;)</div><div class="line">    private BigDecimal quotedPrice;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * 分期信息</div><div class="line">     */</div><div class="line">    @OneToMany(cascade = &#123;CascadeType.REFRESH, CascadeType.PERSIST, CascadeType.MERGE&#125;, fetch = FetchType.LAZY, orphanRemoval = true)</div><div class="line">    @JoinColumn(name = &quot;order_id&quot;)</div><div class="line">    @Where(clause = &quot;delete_flag = 1&quot;)</div><div class="line">    private List&lt;Installment&gt; installments;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * 删除状态</div><div class="line">     */</div><div class="line">    @Enumerated(EnumType.ORDINAL)</div><div class="line">    @Column(name = &quot;delete_flag&quot;)</div><div class="line">    private Status status;</div><div class="line">    ……</div></pre></td></tr></table></figure></p>
<p>Installment.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">@Entity</div><div class="line">@Table(name = &quot;installment&quot;)</div><div class="line">@NamedQuery(name = &quot;Installment.findAll&quot;, query = &quot;SELECT o FROM Installment o&quot;)</div><div class="line">public class Installment extends AbstractModel &#123;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * 分期主键</div><div class="line">     */</div><div class="line">    @Id</div><div class="line">    @GeneratedValue(strategy = GenerationType.IDENTITY)</div><div class="line">    private Long id;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * 订单标识</div><div class="line">     */</div><div class="line">    @Column(name = &quot;order_id&quot;)</div><div class="line">    private Long orderId;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * 分期金额</div><div class="line">     */</div><div class="line">    @Column(name = &quot;quoted_price&quot;)</div><div class="line">    private BigDecimal quotedPrice;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * 删除标识</div><div class="line">     */</div><div class="line">    @Enumerated(EnumType.ORDINAL)</div><div class="line">    @Column(name = &quot;delete_flag&quot;)</div><div class="line">    private Status status;</div><div class="line">    ……</div></pre></td></tr></table></figure>
<h3 id="1-被关联表的id不作为其他表的外键关联"><a href="#1-被关联表的id不作为其他表的外键关联" class="headerlink" title="1. 被关联表的id不作为其他表的外键关联"></a>1. 被关联表的id不作为其他表的外键关联</h3><p>如果被关联的表的id没有被其他表的外键关联，可以进行“全删全加”进行被关联表的进行增删改的操作。</p>
<p>fillingModifyPara</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">……</div><div class="line">order.setOrderNumber(orderDTO.getOrderNumbber());</div><div class="line">order.setQuotedPrice(orderDTO.getQuotedPrice());</div><div class="line">List&lt;InstallmentDTO&gt; installmentDTOs = orderDTO.getInstallments();</div><div class="line">List&lt;Installment&gt; installments = new ArrayList&lt;&gt;();</div><div class="line">for (InstallmentDTO installmentDTO : installmentDTOs) &#123;</div><div class="line">//可以写构造函数进行初始操作</div><div class="line">    Installment installment = new Installment();</div><div class="line">    installment.setOrderId();//修改操作，orderId由前端传入</div><div class="line">    installment.setQuotedPrice(installmentDTO.gettQuotedPrice());</div><div class="line">    installments.add(installment);</div><div class="line">&#125;</div><div class="line">order.getInstallments().clear();</div><div class="line">order.getInstallments().addAll(installments);</div></pre></td></tr></table></figure>
<p>这种方法将原来关联的表的相关内容先物理删除，再将新的内容全部添加上去。优点是方便简单，没有冗余数据；缺点是被关联的表的id不能作为其他表的外键关联。这里注意不要对installment再定义一个对象后进行order.set的操作，这样会出现两个对象而报错，详情可以参看hb源码。</p>
<h3 id="2-被关联表的id可能还关联了一堆乱七八糟的东西"><a href="#2-被关联表的id可能还关联了一堆乱七八糟的东西" class="headerlink" title="2. 被关联表的id可能还关联了一堆乱七八糟的东西"></a>2. 被关联表的id可能还关联了一堆乱七八糟的东西</h3><p>当被关联表的id可能还关联了一堆乱七八糟的东西的时候，就不能进行简单的“全删全加”操作来修改关联表的内容。这个时候的做法是现将从数据库中查出的联表信息全部逻辑删除（status设为无效），然后与传入的进行比对，id相同的将status设置为有效，并修改内容；传入的DTO中没有id的作为新增的加入。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">order.setOrderNumber(orderDTO.getOrderNumbber());</div><div class="line">order.setQuotedPrice(quotationDTO.getQuotedPrice());</div><div class="line">List&lt;Installment&gt; installments = orders.getInstallments();</div><div class="line">List&lt;InstallmentDTO&gt; installmentDTOS = quotationDTO.getInstallmentList();</div><div class="line">List&lt;Installment&gt; newInstallments = new ArrayList&lt;&gt;();</div><div class="line">installments.forEach(installment -&gt; &#123;installment.setStatus(Status.INVALID);&#125;);</div><div class="line">for (InstallmentDTO installmentDTO : installmentDTOS) &#123;</div><div class="line">    for (Installment installment : installments) &#123;</div><div class="line">        if (installment.getId().equals(installmentDTO.getId())) &#123;</div><div class="line">            installment.setStatus(Status.VALID);</div><div class="line">            installment.setQuotedPrice(installmentDTO.getQuotedPrice());</div><div class="line">            installment.setOrderId();</div><div class="line">                &#125;</div><div class="line">        &#125;</div><div class="line">        if (installmentDTO.getId() == null) &#123;</div><div class="line">            Installment installment = new Installment();</div><div class="line">            installment.setOrderId();</div><div class="line">            installment.setQuotedPrice(installmentDTO.gettQuotedPrice());</div><div class="line">            newInstallments.add(newInstallment);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">installments.addAll(newInstallments);</div><div class="line">orders.setInstallments(installments);</div></pre></td></tr></table></figure>
</div></article></div></section><footer><div class="paginator"><a href="/2018/03/13/java-BigDecimal比较大小compareTo和equals/" class="prev"><button class="ui button teal">上一篇</button></a><a href="/2017/11/30/Python2-7-pytesser提取图片中文字信息/" class="next"><button class="ui button teal">下一篇</button></a></div><div class="copyright"><p>© 2016 - 2019 <a href="http://yoursite.com">Rosy</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and theme by <a href="https://github.com/littlewin-wang/hexo-theme-casual" target="_blank">casual</a></p></div></footer></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script><script src="/js/jquery.goup.min.js"></script><script src="/js/semantic.min.js"></script><script src="/js/casual.js"></script><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>$(document).ready(function(){$.goup({trigger:100,bottomOffset:100,locationOffset:5,title:'',titleAsText:true});});</script><script>(function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){(w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);})(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');
_st('install','TvAnFS4AVxjiJUvrZJRB','2.0.0');</script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></div></body></html>