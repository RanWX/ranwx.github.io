<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 微信公众号开发（三）——自定义菜单和响应 | Rosy's</title><meta name="description" content="微信公众号开发（三）——自定义菜单和响应 - Rosy"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/casual.css"><link rel="stylesheet" href="/css/semantic.min.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="Rosy's"></head><body><div class="sidebar"><div class="ui vertical inverted menu"><div class="h100"></div><h3 class="ui inverted aligned icon header"><div class="content"><a href="/" class="title-link">ROSY'S</a></div></h3><div class="h50"></div><div class="side-nav"><a href="/" target="_self" class="item">HOME<i class="icon home"></i></a><a href="/archives" target="_self" class="item">ARCHIVE<i class="icon archive"></i></a><a href="/tags" target="_self" class="item">TAGS<i class="icon tags"></i></a><a href="/about" target="_self" class="item">INFO<i class="icon info"></i></a><a href="/atom.xml" target="_self" class="item">RSS<i class="icon rss"></i></a></div><div class="item"><div class="ui inverted transparent icon input"><input type="text" placeholder="Search..." class="st-default-search-input"><i class="search icon"></i></div></div><div class="h50"></div></div><div class="h50 mq"><a class="ui teal big label"><i class="content icon"></i></a></div><div class="author-info"><a href="/" class="img-link"><img src="/me.jpeg" class="author-photo ui tiny circular image"></a><h4 class="ui aligned icon header"><div class="content">Rosy</div></h4><p class="author-desc">常常将自己分裂成三个人用于玩斗地主的双子女 | 热衷于烹饪 | 喜欢刘亦菲</p><div class="social-outer"><div class="social-inner"><a href="http://github.com/RanWX" target="_blank" class="social-link"><i class="icon github"></i></a><a href="http://weibo.com/u/2176147782?refer_flag=1005055010_&amp;is_all=1" target="_blank" class="social-link"><i class="icon weibo"></i></a></div></div></div></div><div class="main"><div class="wrap"><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">微信公众号开发（三）——自定义菜单和响应</h1><div class="post-info"><div class="post-date"><h6 class="ui header"><i class="calendar icon"></i><div class="content">Aug 28, 2018</div></h6></div></div><div class="post-content"><h2 id="1-测试号申请"><a href="#1-测试号申请" class="headerlink" title="1. 测试号申请"></a>1. 测试号申请</h2><p>不同的公众号类型具备不同的接口权限，一般个人申请的是未认证订阅号，没有自定义菜单的功能，只有企业组织科申请工作好认证公众号。不同类型的公众号的不同接口权限详情见：<a href="https://mp.weixin.qq.com/wiki?t=resource/res_main&amp;id=mp1433401084" target="_blank" rel="external">公众号接口权限说明</a>。</p>
<p>我们可以申请一个接口测试号，这个测试号几乎开放所有的接口，可以供测试使用， <a href="https://mp.weixin.qq.com/wiki?t=resource/res_main&amp;id=mp1421137522" target="_blank" rel="external">接口测试号申请</a>。测试号如下图，可以用测试号的appID和appsecret进行接口调用。</p>
<p><img src="http://39.105.210.20:8888/blog_pic/21.png" alt="image"></p>
<h2 id="2-创建自定义菜单"><a href="#2-创建自定义菜单" class="headerlink" title="2. 创建自定义菜单"></a>2. 创建自定义菜单</h2><h3 id="2-1-获取access-token"><a href="#2-1-获取access-token" class="headerlink" title="2.1 获取access_token"></a>2.1 获取access_token</h3><p>获取access_token的接口为GET：<br><a href="https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid=APPID" target="_blank" rel="external">https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid=APPID</a></p>
<p>创建自定义菜单的接口为POST：<a href="https://api.weixin.qq.com/cgi-bin/menu/create?access_token=ACCESSTOKEN" target="_blank" rel="external">https://api.weixin.qq.com/cgi-bin/menu/create?access_token=ACCESSTOKEN</a> 其中需要传的body详见官网文档： <a href="https://mp.weixin.qq.com/wiki?t=resource/res_main&amp;id=mp1421141013" target="_blank" rel="external">自定义菜单创建接口</a>。</p>
<p>可以用postman进行接口调用。这里主要讲通过java程序进行创建。</p>
<p>获取access_token<br>TokenResponseDTO.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TokenResponseDTO</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> Integer errcode;</div><div class="line">    <span class="keyword">private</span> String errmsg;</div><div class="line">    <span class="keyword">private</span> String access_token;</div><div class="line">    <span class="keyword">private</span> String expires_in;</div><div class="line">    <span class="comment">//省略get set</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> String <span class="title">getToken</span><span class="params">(String appId, String appSecret)</span> </span>&#123;</div><div class="line">    String queryTokenUrl = <span class="string">"https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid=&#123;0&#125;&amp;secret=&#123;1&#125;"</span>;</div><div class="line"></div><div class="line">    String newQueryTokenUrl = MessageFormat.format(queryTokenUrl, appId,appSecret);</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        ResponseEntity&lt;TokenResponseDTO&gt; response =restTemplate.getForEntity(newQueryTokenUrl, TokenResponseDTO.class);</div><div class="line">        TokenResponseDTO tokenResponseDTO = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">if</span> (response != <span class="keyword">null</span> &amp;&amp; response.getStatusCode() != <span class="keyword">null</span> &amp;&amp;response.getStatusCode().value() == <span class="number">200</span> &amp;&amp; response.getBody() != <span class="keyword">null</span></div><div class="line">                &amp;&amp; response.getBody().getErrcode() == <span class="keyword">null</span> &amp;&amp;response.getBody().getErrmsg() == <span class="keyword">null</span>) &#123;</div><div class="line">            tokenResponseDTO = response.getBody();</div><div class="line">            LOGGER.info(<span class="string">"get token from weixin, Reponse: "</span> +JsonUtils.encode(response));</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"getToken error! "</span> +response.getBody().getErrcode().toString() + <span class="string">":"</span> +response.getBody().getErrmsg());</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> tokenResponseDTO.getAccess_token();</div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        LOGGER.error(<span class="string">"getToken error!"</span> + e.getMessage());</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e.getMessage());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>因为获取接口的access_token每日的调用次数是有上限的，每次token的过期时间有2个小时，所以可以另外搭一个存access_token的服务器，定时更新access_token。</p>
<h3 id="2-2-创建自定义菜单"><a href="#2-2-创建自定义菜单" class="headerlink" title="2.2 创建自定义菜单"></a>2.2 创建自定义菜单</h3><p>组body的json数据，可以通过组对象，然后转换成json格式的字符串，也可以自己组好json字符串，写在程序里。我们这里采用组对象转换json串的方式，组三个三种类型的一级按钮。</p>
<p>MenuDTO.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MenuDTO</span> </span>&#123;</div><div class="line">    List&lt;ButtonDTO&gt; button;</div><div class="line">    <span class="comment">// get set</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ButtonDTO.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ButtonDTO</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> String type;</div><div class="line">    <span class="keyword">private</span> String name;</div><div class="line">    <span class="keyword">private</span> String key;</div><div class="line">    <span class="keyword">private</span> String url;</div><div class="line">    ButtonDTO()&#123;&#125;</div><div class="line">    ButtonDTO(String type, String name, String key, String url)&#123;</div><div class="line">        <span class="keyword">this</span>.type = type;</div><div class="line">        <span class="keyword">this</span>.name = name;</div><div class="line">        <span class="keyword">this</span>.key = key;</div><div class="line">        <span class="keyword">this</span>.url = url;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// get set</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createMenu</span><span class="params">(String appId, String appSecret)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> result = <span class="number">0</span>;</div><div class="line">    String accessToken = getToken(appId, appSecret);</div><div class="line">    <span class="comment">// 拼装创建菜单的url</span></div><div class="line">    String menu_create_url =<span class="string">"https://api.weixin.qq.com/cgi-bin/menu/create?access_token=ACCESS_TOKEN"</span>;</div><div class="line">    String url = menu_create_url.replace(<span class="string">"ACCESS_TOKEN"</span>, accessToken);</div><div class="line">    <span class="comment">// 将菜单对象转换成json字符串</span></div><div class="line">    MenuDTO menuDTO = <span class="keyword">new</span> MenuDTO();</div><div class="line">    ButtonDTO buttonDTO1 = <span class="keyword">new</span> ButtonDTO(<span class="string">"pic_photo_or_album"</span>, <span class="string">"上传照片"</span>, <span class="string">"11"</span>, <span class="keyword">null</span>);</div><div class="line">    ButtonDTO buttonDTO2 = <span class="keyword">new</span> ButtonDTO(<span class="string">"click"</span>, <span class="string">"click"</span>, <span class="string">"12"</span>, <span class="keyword">null</span>);</div><div class="line">    ButtonDTO buttonDTO3 = <span class="keyword">new</span> ButtonDTO(<span class="string">"view"</span>, <span class="string">"view"</span>, <span class="keyword">null</span>, <span class="string">"https://weui.io/#uploader"</span>);</div><div class="line">    List&lt;ButtonDTO&gt; buttonDTOList = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">    buttonDTOList.add(buttonDTO1);</div><div class="line">    buttonDTOList.add(buttonDTO2);</div><div class="line">    buttonDTOList.add(buttonDTO3);</div><div class="line">    menuDTO.setButton(buttonDTOList);</div><div class="line">    HttpHeaders headers = <span class="keyword">new</span> HttpHeaders();</div><div class="line">    headers.setContentType(MediaType.APPLICATION_JSON);</div><div class="line">    MultiValueMap&lt;String, String&gt; params = <span class="keyword">new</span> LinkedMultiValueMap&lt;String,String&gt;();</div><div class="line">    params.add(<span class="string">"data"</span>, JsonUtils.encode(menuDTO));</div><div class="line">    System.out.println(JsonUtils.encode(menuDTO));</div><div class="line">    HttpEntity&lt;MultiValueMap&lt;String, String&gt;&gt; requestEntity = newHttpEntity&lt;MultiValueMap&lt;String, String&gt;&gt;(params, headers);</div><div class="line">    RestTemplate restTemplate = <span class="keyword">new</span> RestTemplate();</div><div class="line">    ResponseEntity&lt;String&gt; response = restTemplate.exchange(url,HttpMethod.POST, requestEntity, String.class);</div><div class="line">    System.out.println(response.getBody());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>运行方法，如果没有错误信息，则返回：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;errcode&quot;: 0,</div><div class="line">    &quot;errmsg&quot;: &quot;ok&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>打开测试公众号，可以看到我们新加的自定义菜单。</p>
<p><img src="http://39.105.210.20:8888/blog_pic/22.png" alt="image"></p>
<h2 id="菜单响应"><a href="#菜单响应" class="headerlink" title="菜单响应"></a>菜单响应</h2><p>这里的响应主要针对上传照片和click按钮，view按钮会自动跳转到初始化的url页面上。</p>
<p>在web.xml中配一个servlet</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">servlet</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>weixin<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>com.star.ott.tokenmanage.api.business.CoreServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>weixin<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/wx<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></div></pre></td></tr></table></figure>
<p>CoreServlet.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CoreServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String OK = <span class="string">"OK"</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">get</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> OK;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 确认请求来自微信服务器</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</div><div class="line"></div><div class="line">        <span class="comment">// 微信加密签名</span></div><div class="line">        String signature = request.getParameter(<span class="string">"signature"</span>);</div><div class="line">        <span class="comment">// 时间戳</span></div><div class="line">        String timestamp = request.getParameter(<span class="string">"timestamp"</span>);</div><div class="line">        <span class="comment">// 随机数</span></div><div class="line">        String nonce = request.getParameter(<span class="string">"nonce"</span>);</div><div class="line">        <span class="comment">// 随机字符串</span></div><div class="line">        String echostr = request.getParameter(<span class="string">"echostr"</span>);</div><div class="line">        response.setHeader(<span class="string">"content-type"</span>, <span class="string">"text/html;charset=UTF-8"</span>);</div><div class="line">        PrintWriter out = response.getWriter();</div><div class="line">        <span class="comment">// 通过检验signature对请求进行校验，若校验成功则原样返回echostr，表示接入成功，否则接入失败</span></div><div class="line">        <span class="keyword">if</span> (SignUtil.checkSignature(signature, timestamp, nonce)) &#123;</div><div class="line">            out.print(echostr);</div><div class="line">        &#125;</div><div class="line">        out.close();</div><div class="line">        out = <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 处理微信服务器发来的消息</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</div><div class="line">        <span class="comment">// 将请求、响应的编码均设置为UTF-8（防止中文乱码）</span></div><div class="line">        request.setCharacterEncoding(<span class="string">"UTF-8"</span>);</div><div class="line">        response.setCharacterEncoding(<span class="string">"UTF-8"</span>);</div><div class="line"></div><div class="line">        <span class="comment">// 调用核心业务类接收消息、处理消息</span></div><div class="line">        String respMessage = processRequest(request);</div><div class="line"></div><div class="line">        <span class="comment">// 响应消息</span></div><div class="line">        PrintWriter out = response.getWriter();</div><div class="line">        out.print(respMessage);</div><div class="line">        out.close();</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">processRequest</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</div><div class="line">        String respMessage = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">// 默认返回的文本消息内容</span></div><div class="line">            String respContent = <span class="string">"请求处理异常，请稍候尝试！"</span>;</div><div class="line"></div><div class="line">            <span class="comment">// xml请求解析</span></div><div class="line">            Map&lt;String, String&gt; requestMap = MessageUtil.parseXml(request);</div><div class="line"></div><div class="line">            <span class="comment">// 发送方帐号（open_id）</span></div><div class="line">            String fromUserName = requestMap.get(<span class="string">"FromUserName"</span>);</div><div class="line">            <span class="comment">// 公众帐号</span></div><div class="line">            String toUserName = requestMap.get(<span class="string">"ToUserName"</span>);</div><div class="line">            <span class="comment">// 消息类型</span></div><div class="line">            String msgType = requestMap.get(<span class="string">"MsgType"</span>);</div><div class="line"></div><div class="line">            <span class="comment">// 回复文本消息</span></div><div class="line">            TextMessage textMessage = <span class="keyword">new</span> TextMessage();</div><div class="line">            textMessage.setToUserName(fromUserName);</div><div class="line">            textMessage.setFromUserName(toUserName);</div><div class="line">            textMessage.setCreateTime(<span class="keyword">new</span> Date().getTime());</div><div class="line">            textMessage.setMsgType(MessageUtil.RESP_MESSAGE_TYPE_TEXT);</div><div class="line">            textMessage.setFuncFlag(<span class="number">0</span>);</div><div class="line"></div><div class="line">            <span class="comment">// 图片消息</span></div><div class="line">            <span class="keyword">if</span> (msgType.equals(MessageUtil.REQ_MESSAGE_TYPE_IMAGE)) &#123;</div><div class="line">                respContent = <span class="string">"您发送的是图片消息！"</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// 事件推送</span></div><div class="line">            <span class="keyword">if</span> (msgType.equals(MessageUtil.REQ_MESSAGE_TYPE_EVENT)) &#123;</div><div class="line">                <span class="comment">// 事件类型</span></div><div class="line">                String eventType = requestMap.get(<span class="string">"Event"</span>);</div><div class="line">                <span class="keyword">if</span> (eventType.equals(MessageUtil.EVENT_TYPE_CLICK)) &#123;</div><div class="line">                    <span class="comment">// 事件KEY值，与创建自定义菜单时指定的KEY值对应</span></div><div class="line">                    String eventKey = requestMap.get(<span class="string">"EventKey"</span>);</div><div class="line"></div><div class="line">                    <span class="keyword">if</span> (eventKey.equals(<span class="string">"12"</span>)) &#123;</div><div class="line">                        respContent = <span class="string">"被点击！"</span>;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            textMessage.setContent(respContent);</div><div class="line">            respMessage = MessageUtil.textMessageToXml(textMessage);</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> respMessage;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>SignUtil.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SignUtil</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String token = <span class="string">"weixintest"</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 验证签名</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> signature</div><div class="line">     * <span class="doctag">@param</span> timestamp</div><div class="line">     * <span class="doctag">@param</span> nonce</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">checkSignature</span><span class="params">(String signature, String timestamp, String nonce)</span> </span>&#123;</div><div class="line">        String[] arr = <span class="keyword">new</span> String[]&#123;token, timestamp, nonce&#125;;</div><div class="line">        <span class="comment">// 将token、timestamp、nonce三个参数进行字典序排序</span></div><div class="line">        Arrays.sort(arr);</div><div class="line">        StringBuilder content = <span class="keyword">new</span> StringBuilder();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; arr.length; i++) &#123;</div><div class="line">            content.append(arr[i]);</div><div class="line">        &#125;</div><div class="line">        MessageDigest md = <span class="keyword">null</span>;</div><div class="line">        String tmpStr = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            md = MessageDigest.getInstance(<span class="string">"SHA-1"</span>);</div><div class="line">            <span class="comment">// 将三个参数字符串拼接成一个字符串进行sha1加密</span></div><div class="line">            <span class="keyword">byte</span>[] digest = md.digest(content.toString().getBytes());</div><div class="line">            tmpStr = byteToStr(digest);</div><div class="line">        &#125; <span class="keyword">catch</span> (NoSuchAlgorithmException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        content = <span class="keyword">null</span>;</div><div class="line">        <span class="comment">// 将sha1加密后的字符串可与signature对比，标识该请求来源于微信</span></div><div class="line">        <span class="keyword">return</span> tmpStr != <span class="keyword">null</span> ? tmpStr.equals(signature.toUpperCase()) : <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 将字节数组转换为十六进制字符串</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> byteArray</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">byteToStr</span><span class="params">(<span class="keyword">byte</span>[] byteArray)</span> </span>&#123;</div><div class="line">        String strDigest = <span class="string">""</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; byteArray.length; i++) &#123;</div><div class="line">            strDigest += byteToHexStr(byteArray[i]);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> strDigest;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 将字节转换为十六进制字符串</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> mByte</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">byteToHexStr</span><span class="params">(<span class="keyword">byte</span> mByte)</span> </span>&#123;</div><div class="line">        <span class="keyword">char</span>[] Digit = &#123;<span class="string">'0'</span>, <span class="string">'1'</span>, <span class="string">'2'</span>, <span class="string">'3'</span>, <span class="string">'4'</span>, <span class="string">'5'</span>, <span class="string">'6'</span>, <span class="string">'7'</span>, <span class="string">'8'</span>, <span class="string">'9'</span>, <span class="string">'A'</span>, <span class="string">'B'</span>, <span class="string">'C'</span>, <span class="string">'D'</span>, <span class="string">'E'</span>, <span class="string">'F'</span>&#125;;</div><div class="line">        <span class="keyword">char</span>[] tempArr = <span class="keyword">new</span> <span class="keyword">char</span>[<span class="number">2</span>];</div><div class="line">        tempArr[<span class="number">0</span>] = Digit[(mByte &gt;&gt;&gt; <span class="number">4</span>) &amp; <span class="number">0X0F</span>];</div><div class="line">        tempArr[<span class="number">1</span>] = Digit[mByte &amp; <span class="number">0X0F</span>];</div><div class="line"></div><div class="line">        String s = <span class="keyword">new</span> String(tempArr);</div><div class="line">        <span class="keyword">return</span> s;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>MessageUtil.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageUtil</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 返回消息类型：文本</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String RESP_MESSAGE_TYPE_TEXT = <span class="string">"text"</span>;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 请求消息类型：图片</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String REQ_MESSAGE_TYPE_IMAGE = <span class="string">"image"</span>;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String REQ_MESSAGE_TYPE_EVENT = <span class="string">"event"</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 事件类型：CLICK(自定义菜单点击事件)</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String EVENT_TYPE_CLICK = <span class="string">"CLICK"</span>;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String EVENT_TYPE_PHOTO = <span class="string">"pic_photo_or_album"</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 解析微信发来的请求（XML）</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> request</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     * <span class="doctag">@throws</span> Exception</div><div class="line">     */</div><div class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Map&lt;String, String&gt; <span class="title">parseXml</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="comment">// 将解析结果存储在HashMap中</span></div><div class="line">        Map&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</div><div class="line"></div><div class="line">        <span class="comment">// 从request中取得输入流</span></div><div class="line">        InputStream inputStream = request.getInputStream();</div><div class="line">        <span class="comment">// 读取输入流</span></div><div class="line">        SAXReader reader = <span class="keyword">new</span> SAXReader();</div><div class="line">        Document document = reader.read(inputStream);</div><div class="line">        <span class="comment">// 得到xml根元素</span></div><div class="line">        Element root = document.getRootElement();</div><div class="line">        <span class="comment">// 得到根元素的所有子节点</span></div><div class="line">        List&lt;Element&gt; elementList = root.elements();</div><div class="line"></div><div class="line">        <span class="comment">// 遍历所有子节点</span></div><div class="line">        <span class="keyword">for</span> (Element e : elementList)</div><div class="line">            map.put(e.getName(), e.getText());</div><div class="line"></div><div class="line">        <span class="comment">// 释放资源</span></div><div class="line">        inputStream.close();</div><div class="line">        inputStream = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> map;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 文本消息对象转换成xml</div><div class="line">     * <span class="doctag">@param</span> textMessage 文本消息对象</div><div class="line">     * <span class="doctag">@return</span> xml</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">textMessageToXml</span><span class="params">(TextMessage textMessage)</span> </span>&#123;</div><div class="line">        xstream.alias(<span class="string">"xml"</span>, textMessage.getClass());</div><div class="line">        <span class="keyword">return</span> xstream.toXML(textMessage);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 扩展xstream，使其支持CDATA块</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> XStream xstream = <span class="keyword">new</span> XStream(<span class="keyword">new</span> XppDriver() &#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> HierarchicalStreamWriter <span class="title">createWriter</span><span class="params">(Writer out)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> PrettyPrintWriter(out) &#123;</div><div class="line">                <span class="comment">// 对所有xml节点的转换都增加CDATA标记</span></div><div class="line">                <span class="keyword">boolean</span> cdata = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">                <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startNode</span><span class="params">(String name, Class clazz)</span> </span>&#123;</div><div class="line">                    <span class="keyword">super</span>.startNode(name, clazz);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">writeText</span><span class="params">(QuickWriter writer, String text)</span> </span>&#123;</div><div class="line">                    <span class="keyword">if</span> (cdata) &#123;</div><div class="line">                        writer.write(<span class="string">"&lt;![CDATA["</span>);</div><div class="line">                        writer.write(text);</div><div class="line">                        writer.write(<span class="string">"]]&gt;"</span>);</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        writer.write(text);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;;</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>参考文章：<a href="https://blog.csdn.net/lyq8479/article/details/8952173" target="_blank" rel="external">https://blog.csdn.net/lyq8479/article/details/8952173</a></p>
</div></article></div></section><footer><div class="paginator"><a href="/2019/04/10/logstash安装配置/" class="prev"><button class="ui button teal">PREV</button></a><a href="/2018/08/28/微信公众号开发（二）——本地调试/" class="next"><button class="ui button teal">NEXT</button></a></div><div class="copyright"><p>© 2016 - 2019 <a href="http://yoursite.com">Rosy</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and theme by <a href="https://github.com/littlewin-wang/hexo-theme-casual" target="_blank">casual</a></p></div></footer></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script><script src="/js/jquery.goup.min.js"></script><script src="/js/semantic.min.js"></script><script src="/js/casual.js"></script><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>$(document).ready(function(){$.goup({trigger:100,bottomOffset:100,locationOffset:5,title:'',titleAsText:true});});</script><script>(function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){(w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);})(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');
_st('install','TvAnFS4AVxjiJUvrZJRB','2.0.0');</script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></div></body></html>