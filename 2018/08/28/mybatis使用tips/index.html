<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> mybatis使用tips | Rosy's</title><meta name="description" content="mybatis使用tips - Rosy"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/casual.css"><link rel="stylesheet" href="/css/semantic.min.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="Rosy's"></head><body><div class="sidebar"><div class="ui vertical inverted menu"><div class="h100"></div><h3 class="ui inverted aligned icon header"><div class="content"><a href="/" class="title-link">ROSY'S</a></div></h3><div class="h50"></div><div class="side-nav"><a href="/" target="_self" class="item">HOME<i class="icon home"></i></a><a href="/archives" target="_self" class="item">ARCHIVE<i class="icon archive"></i></a><a href="/tags" target="_self" class="item">TAGS<i class="icon tags"></i></a><a href="/about" target="_self" class="item">INFO<i class="icon info"></i></a><a href="/atom.xml" target="_self" class="item">RSS<i class="icon rss"></i></a></div><div class="item"><div class="ui inverted transparent icon input"><input type="text" placeholder="Search..." class="st-default-search-input"><i class="search icon"></i></div></div><div class="h50"></div></div><div class="h50 mq"><a class="ui teal big label"><i class="content icon"></i></a></div><div class="author-info"><a href="/" class="img-link"><img src="/me.jpeg" class="author-photo ui tiny circular image"></a><h4 class="ui aligned icon header"><div class="content">Rosy</div></h4><p class="author-desc">常常将自己分裂成三个人用于玩斗地主的双子女 | 热衷于烹饪 | 喜欢刘亦菲</p><div class="social-outer"><div class="social-inner"><a href="http://github.com/RanWX" target="_blank" class="social-link"><i class="icon github"></i></a><a href="http://weibo.com/u/2176147782?refer_flag=1005055010_&amp;is_all=1" target="_blank" class="social-link"><i class="icon weibo"></i></a></div></div></div></div><div class="main"><div class="wrap"><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">mybatis使用tips</h1><div class="post-info"><div class="post-date"><h6 class="ui header"><i class="calendar icon"></i><div class="content">Aug 28, 2018</div></h6></div></div><div class="post-content"><p>mybatis作为一种灵活的orm框架，优点有目共睹：灵活！不管多复杂的查询，联表，多对多，联表count。。。只要能把sql语句写出来，就能查出来转成PO。然鹅，在使用的时候也充分暴露了，越是灵活的东西，越容易出bug。比如买个面包机，我只需要按照说明书，往里加面粉，酵母，糖等配料就行了，做出来的东西起码符合食物的最低标准——能吃！但是如果给你一个烤箱做面包，理论上你可以做各种形状各种口味的：牛角面包，吐司，法棍。。然而事实上，可能做出来的东西并不能称之为“食物”。mybatis就是一个烤箱，能做任何事情，又不能做任何事情。</p>
<h2 id="1-搜索条件传入参数类型是Integer，Long"><a href="#1-搜索条件传入参数类型是Integer，Long" class="headerlink" title="1. 搜索条件传入参数类型是Integer，Long"></a>1. 搜索条件传入参数类型是Integer，Long</h2><p>例如枚举类型，前端传入的是枚举的名称，而数据库存的是枚举值对应的数字，我们的做法是，先找到枚举值对应的数字，然后用数字去数据库进行搜索。</p>
<p>例：</p>
<p>接口Mapper.java：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function">List&lt;TaskApplicationBO&gt; <span class="title">findTaskApplicationsByCondition</span><span class="params">(@Param(<span class="string">"taskApplicationStatus"</span>)</span> Integer taskApplicationStatus)</span>;</div></pre></td></tr></table></figure>
<p>对应的Mapper.xml的搜索：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">select ta.id id, ta.task_application_status task_application_status</div><div class="line">from task_application ta</div><div class="line">where ta.delete_flag = 1</div><div class="line"><span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"taskApplicationStatus != null and taskApplicationStatus != ''"</span>&gt;</span></div><div class="line">    and ta.task_application_status = #&#123;taskApplicationStatus&#125;</div><div class="line"><span class="tag">&lt;/<span class="name">if</span>&gt;</span></div></pre></td></tr></table></figure>
<p>这个时候，如果传入的taskApplicationStatus值是0，则会搜索出全部。</p>
<p>sql打印如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> ta.id <span class="keyword">id</span>, ta.task_application_status task_application_status <span class="keyword">FROM</span> task_application ta <span class="keyword">WHERE</span> ta.delete_flag = <span class="number">1</span></div></pre></td></tr></table></figure>
<p>传入的taskApplicationStatus值是其他值，则会拼接上搜索条件进行搜索。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> ta.id <span class="keyword">id</span>, ta.task_application_status task_application_status <span class="keyword">FROM</span> task_application ta <span class="keyword">WHERE</span> ta.delete_flag = <span class="number">1</span> <span class="keyword">and</span> ta.task_application_status = ?</div><div class="line"><span class="keyword">Parameters</span>: <span class="number">1</span>(<span class="built_in">Integer</span>)</div></pre></td></tr></table></figure>
<p>由打印出的sql可以看出，当taskApplicationStatus为0的时候，没有进入if条件里。</p>
<p>通过Debug MyBatis源找到了IfSqlNode类，该类用来处理动态SQL的<if>节点。</if></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IfSqlNode</span> <span class="keyword">implements</span> <span class="title">SqlNode</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> ExpressionEvaluator evaluator;</div><div class="line">  <span class="keyword">private</span> String test;</div><div class="line">  <span class="keyword">private</span> SqlNode contents;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">IfSqlNode</span><span class="params">(SqlNode contents, String test)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.test = test;</div><div class="line">    <span class="keyword">this</span>.contents = contents;</div><div class="line">    <span class="keyword">this</span>.evaluator = <span class="keyword">new</span> ExpressionEvaluator();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">apply</span><span class="params">(DynamicContext context)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (evaluator.evaluateBoolean(test, context.getBindings())) &#123;</div><div class="line">      contents.apply(context);</div><div class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其中方法public boolean apply(DynamicContext context)用来构造节点内的SQL语句。if (evaluator.evaluateBoolean(test, context.getBindings())该代码便是解析<if test="status !=null and status !=''">中test内表达式的关键，如果表达式为true则拼接SQL，否则忽略。</if></p>
<p>ExpressionEvaluator 类，通过OgnlCache.getValue(expression, parameterObject);可以看到表达式的值是从缓存中获取的，由此可知MyBatis竟然对表达式做了缓存，以提高性能。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExpressionEvaluator</span> </span>&#123;  </div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">evaluateBoolean</span><span class="params">(String expression, Object parameterObject)</span> </span>&#123;  </div><div class="line">    Object value = OgnlCache.getValue(expression, parameterObject);  </div><div class="line">    <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Boolean) <span class="keyword">return</span> (Boolean) value;  </div><div class="line">    <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Number) <span class="keyword">return</span> !<span class="keyword">new</span> BigDecimal(String.valueOf(value)).equals(BigDecimal.ZERO);  </div><div class="line">    <span class="keyword">return</span> value != <span class="keyword">null</span>;  </div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>解析表达式的方法private static Object parseExpression(String expression),该方法会先从缓存取值，如果没有便进行解析并放入缓存中，然后调用Ognl.getValue(parseExpression(expression), root)获得表达式的值。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OgnlCache</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, ognl.Node&gt; expressionCache = <span class="keyword">new</span> ConcurrentHashMap&lt;String, ognl.Node&gt;();</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">getValue</span><span class="params">(String expression, Object root)</span> <span class="keyword">throws</span> OgnlException </span>&#123;</div><div class="line">    <span class="keyword">return</span> Ognl.getValue(parseExpression(expression), root);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Object <span class="title">parseExpression</span><span class="params">(String expression)</span> <span class="keyword">throws</span> OgnlException </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      Node node = expressionCache.get(expression);</div><div class="line">      <span class="keyword">if</span> (node == <span class="keyword">null</span>) &#123;</div><div class="line">        node = <span class="keyword">new</span> OgnlParser(<span class="keyword">new</span> StringReader(expression)).topLevelExpression();</div><div class="line">        expressionCache.put(expression, node);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span> node;</div><div class="line">    &#125; <span class="keyword">catch</span> (ParseException e) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ExpressionSyntaxException(expression, e);</div><div class="line">    &#125; <span class="keyword">catch</span> (TokenMgrError e) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ExpressionSyntaxException(expression, e);</div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>MyBatis的表达式是用<a href="https://commons.apache.org/proper/commons-ognl/language-guide.html" target="_blank" rel="external">OGNL</a>处理的，OGNL的官网中对表达式返回Boolean类型有以下解释：</p>
<p><img src="http://106.13.2.39:8888/blog_pic/18.png" alt="image"></p>
<p>如果对象是一个Number类型，值为0时将被解析为false，否则为true，浮点型0.00也是如此。</p>
<p><if test="taskApplicationStatus != null and taskApplicationStatus != ''"><br>    and ta.task_application_status = #{taskApplicationStatus}<br></if><br>时出现的问题了， taskApplicationStatus != ‘’被解析为false,而’’被解析为false，因此taskApplicationStatus!=’’是不成立的，表达式的值为false，导致无法拼接搜索条件。一般只有传入为String类型的时候才需要判断是否为String != ‘’。</p>
<p><strong>解决方法</strong></p>
<ul>
<li>去掉test表达式中的taskApplicationStatus != ‘’内容</li>
<li>增加一个判断条件 or taskApplicationStatus == 0</li>
</ul>
<p>另外如果你有类似于String str =”A”;  <if test="str!= null and str == 'A'">这样的写法时，因为单引号内如果为单个字符时，OGNL将会识别为Java 中的 char类型，显然String 类型与char类型做==运算会返回false，从而导致表达式不成立。解决方法很简单，修改为<if test="str!= null and str == "A"">即可；也可以做toString的转化<if test="str!= null and str == 'A'.toString()"></if></if></if></p>
<h2 id="2-动态拼接sql时的特殊字符"><a href="#2-动态拼接sql时的特殊字符" class="headerlink" title="2. 动态拼接sql时的特殊字符"></a>2. 动态拼接sql时的特殊字符</h2><p>严格来说这是mysql和url编码（通过http发起请求时参数识别）的问题，需要提前做个字符转化，且几乎无法穷举特殊字符，只能转化常见的。</p>
<p>比如“#”和“&amp;”，在发起http请求时，“#”以后的内容会被忽略，而“&amp;”作为参数拼接的符号，其后跟的内容会被认为是传入的参数，而本身作为参数传入时讲无法辨认。需要在前端进行转化。</p>
<p>mysql的特殊字符，比如“%”和“/”等。则是mysql的特殊字符，需要在拼接sql前进行转义。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">value = value.replaceAll(<span class="string">"/"</span>, ESCAPE_CHAR + <span class="string">"/"</span>);</div><div class="line">value = value.replaceAll(<span class="string">"%"</span>, ESCAPE_CHAR + <span class="string">"%"</span>);</div><div class="line">value = value.replaceAll(<span class="string">"_"</span>, ESCAPE_CHAR + <span class="string">"_"</span>);</div><div class="line">value = value.replaceAll(<span class="string">"'"</span>, <span class="string">"''"</span>);</div></pre></td></tr></table></figure>
<h2 id="3-传入List组in语句"><a href="#3-传入List组in语句" class="headerlink" title="3. 传入List组in语句"></a>3. 传入List组in语句</h2><p>其实这也是mysql的问题，传入List，拼接in语句，如果传入的List集合是数字类型（如Integer，Long），查询返回的集合会根据数字大小进行升序排序（如果传入的List是String则不会）。因此如果需要原始顺序，需要对查询字段进行排序，具体如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;foreach collection="ids" item="item" open="(" separator="," close=")"&gt;</div><div class="line">    #&#123;item&#125;</div><div class="line">&lt;/foreach&gt;</div><div class="line">     ORDER BY FIELD</div><div class="line">&lt;foreach collection="ids" item="item" open="(id," separator="," close=")"&gt;</div><div class="line">    #&#123;item&#125;</div><div class="line">&lt;/foreach&gt;</div></pre></td></tr></table></figure>
<h2 id="4-其他"><a href="#4-其他" class="headerlink" title="4. 其他"></a>4. 其他</h2><p>未完待续。。。。。。</p>
</div></article></div></section><footer><div class="paginator"><a href="/2018/08/28/微信公众号开发（一）——搭建环境/" class="prev"><button class="ui button teal">PREV</button></a><a href="/2018/07/31/hibernate实体类与数据库表的常见映射/" class="next"><button class="ui button teal">NEXT</button></a></div><div class="copyright"><p>© 2016 - 2020 <a href="http://yoursite.com">Rosy</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and theme by <a href="https://github.com/littlewin-wang/hexo-theme-casual" target="_blank">casual</a></p></div></footer></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script><script src="/js/jquery.goup.min.js"></script><script src="/js/semantic.min.js"></script><script src="/js/casual.js"></script><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>$(document).ready(function(){$.goup({trigger:100,bottomOffset:100,locationOffset:5,title:'',titleAsText:true});});</script><script>(function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){(w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);})(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');
_st('install','TvAnFS4AVxjiJUvrZJRB','2.0.0');</script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></div></body></html>