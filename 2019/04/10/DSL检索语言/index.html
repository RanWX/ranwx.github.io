<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> DSL检索语言 | Rosy's</title><meta name="description" content="DSL检索语言 - Rosy"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/casual.css"><link rel="stylesheet" href="/css/semantic.min.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="Rosy's"></head><body><div class="sidebar"><div class="ui vertical inverted menu"><div class="h100"></div><h3 class="ui inverted aligned icon header"><div class="content"><a href="/" class="title-link">ROSY'S</a></div></h3><div class="h50"></div><div class="side-nav"><a href="/" target="_self" class="item">HOME<i class="icon home"></i></a><a href="/archives" target="_self" class="item">ARCHIVE<i class="icon archive"></i></a><a href="/tags" target="_self" class="item">TAGS<i class="icon tags"></i></a><a href="/about" target="_self" class="item">INFO<i class="icon info"></i></a><a href="/atom.xml" target="_self" class="item">RSS<i class="icon rss"></i></a></div><div class="item"><div class="ui inverted transparent icon input"><input type="text" placeholder="Search..." class="st-default-search-input"><i class="search icon"></i></div></div><div class="h50"></div></div><div class="h50 mq"><a class="ui teal big label"><i class="content icon"></i></a></div><div class="author-info"><a href="/" class="img-link"><img src="/me.jpeg" class="author-photo ui tiny circular image"></a><h4 class="ui aligned icon header"><div class="content">Rosy</div></h4><p class="author-desc">常常将自己分裂成三个人用于玩斗地主的双子女 | 热衷于烹饪 | 喜欢刘亦菲</p><div class="social-outer"><div class="social-inner"><a href="http://github.com/RanWX" target="_blank" class="social-link"><i class="icon github"></i></a><a href="http://weibo.com/u/2176147782?refer_flag=1005055010_&amp;is_all=1" target="_blank" class="social-link"><i class="icon weibo"></i></a></div></div></div></div><div class="main"><div class="wrap"><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">DSL检索语言</h1><div class="post-info"><div class="post-date"><h6 class="ui header"><i class="calendar icon"></i><div class="content">Apr 10, 2019</div></h6></div></div><div class="post-content"><p>ES中的聚合被分为两大类：Metric度量和bucket桶。metric很像SQL中的avg、max、min等方法，而bucket就有点类似group by。</p>
<h2 id="1-单值聚合"><a href="#1-单值聚合" class="headerlink" title="1. 单值聚合"></a>1. 单值聚合</h2><ul>
<li><p>求和：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&quot;aggs&quot; : &#123;</div><div class="line">       &quot;intraday_return&quot; : &#123; &quot;sum&quot; : &#123; &quot;field&quot; : &quot;change&quot; &#125; &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
</li>
<li><p>求最大值、最小值和平均值</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;aggs&quot; : &#123;</div><div class="line">        &quot;min_price&quot; : &#123; &quot;min&quot; : &#123; &quot;field&quot; : &quot;price&quot; &#125; &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;aggs&quot; : &#123;</div><div class="line">        &quot;max_price&quot; : &#123; &quot;max&quot; : &#123; &quot;field&quot; : &quot;price&quot; &#125; &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;aggs&quot; : &#123;</div><div class="line">        &quot;avg_grade&quot; : &#123; &quot;avg&quot; : &#123; &quot;field&quot; : &quot;grade&quot; &#125; &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>求唯一值，即不重复的字段有多少</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;aggs&quot; : &#123;</div><div class="line">        &quot;author_count&quot; : &#123;</div><div class="line">            &quot;cardinality&quot; : &#123;</div><div class="line">                &quot;field&quot; : &quot;author&quot;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="2-多值聚合"><a href="#2-多值聚合" class="headerlink" title="2. 多值聚合"></a>2. 多值聚合</h2><ul>
<li>求百分比</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;aggs&quot; : &#123;</div><div class="line">        &quot;load_time_outlier&quot; : &#123;</div><div class="line">            &quot;percentile_ranks&quot; : &#123;</div><div class="line">                &quot;field&quot; : &quot;load_time&quot;, </div><div class="line">                &quot;values&quot; : [15, 30]</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>stats统计</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;aggs&quot; : &#123;</div><div class="line">        &quot;grades_stats&quot; : &#123; &quot;stats&quot; : &#123; &quot;field&quot; : &quot;grade&quot; &#125; &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>扩展统计</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;aggs&quot; : &#123;</div><div class="line">        &quot;grades_stats&quot; : &#123; &quot;extended_stats&quot; : &#123; &quot;field&quot; : &quot;grade&quot; &#125; &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="3-terms聚合"><a href="#3-terms聚合" class="headerlink" title="3. terms聚合"></a>3. terms聚合</h2><p>terms聚合，它是按照某个字段中的值来分类：比如性别有男、女，就会创建两个桶，分别存放男女的信息。默认会搜集doc_count的信息，即记录有多少男生，有多少女生，然后返回给客户端，这样就完成了一个terms得统计</p>
<p>Bucket可以理解为一个桶，他会遍历文档中的内容，凡是符合要求的就放入按照要求创建的桶中。</p>
<ul>
<li>terms聚合</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;aggs&quot; : &#123;</div><div class="line">        &quot;genders&quot; : &#123;</div><div class="line">            &quot;terms&quot; : &#123; &quot;field&quot; : &quot;gender&quot; &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>order排序</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;aggs&quot; : &#123;</div><div class="line">        &quot;genders&quot; : &#123;</div><div class="line">            &quot;terms&quot; : &#123;</div><div class="line">                &quot;field&quot; : &quot;gender&quot;,</div><div class="line">                &quot;order&quot; : &#123; &quot;_count&quot; : &quot;asc&quot; &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>也可以通过order指定一个单值的metric聚合，来排序。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;aggs&quot; : &#123;</div><div class="line">        &quot;genders&quot; : &#123;</div><div class="line">            &quot;terms&quot; : &#123;</div><div class="line">                &quot;field&quot; : &quot;gender&quot;,</div><div class="line">                &quot;order&quot; : &#123; &quot;avg_height&quot; : &quot;desc&quot; &#125;</div><div class="line">            &#125;,</div><div class="line">            &quot;aggs&quot; : &#123;</div><div class="line">                &quot;avg_height&quot; : &#123; &quot;avg&quot; : &#123; &quot;field&quot; : &quot;height&quot; &#125; &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>min_doc_count与shard_min_doc_count</li>
</ul>
<p>聚合的字段可能存在一些频率很低的词条，如果这些词条数目比例很大，那么就会造成很多不必要的计算。<br>因此可以通过设置min_doc_count和shard_min_doc_count来规定最小的文档数目，只有满足这个参数要求的个数的词条才会被记录返回。</p>
<ul>
<li>filter</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;aggs&quot; : &#123;</div><div class="line">        &quot;tags&quot; : &#123;</div><div class="line">            &quot;terms&quot; : &#123;</div><div class="line">                &quot;field&quot; : &quot;tags&quot;,</div><div class="line">                &quot;include&quot; : &quot;.*sport.*&quot;,</div><div class="line">                &quot;exclude&quot; : &quot;water_.*&quot;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="4-Histogram-直方图聚合"><a href="#4-Histogram-直方图聚合" class="headerlink" title="4. Histogram 直方图聚合"></a>4. Histogram 直方图聚合</h2><p>Elasticsearch支持直方图聚合，它在数字字段自动创建桶，并会扫描全部文档，把文档放入相应的桶中。这个数字字段既可以是文档中的某个字段，也可以通过脚本创建得出的。举个例子，有一个price字段，这个字段描述了商品的价格，现在想每隔5就创建一个桶，统计每隔区间都有多少个文档（商品）。如果有一个商品的价格为32，那么它会被放入30的桶中。</p>
<ul>
<li>min_doc_count过滤</li>
</ul>
<p>如果不想要显示count为0的桶，可以通过min_doc_count来设置。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;aggs&quot; : &#123;</div><div class="line">        &quot;prices&quot; : &#123;</div><div class="line">            &quot;histogram&quot; : &#123;</div><div class="line">                &quot;field&quot; : &quot;price&quot;,</div><div class="line">                &quot;interval&quot; : 50,</div><div class="line">                &quot;min_doc_count&quot; : 1</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>extend_bounds</li>
</ul>
<p>指定最小值和最大值边界.默认情况下，ES中的histogram聚合起始都是自动的，比如price字段，如果没有商品的价钱在0-5之间，0这个桶就不会显示。如果最便宜的商品是11，那么第一个桶就是10.<br>可以通过设置extend_bounds强制规定最小值和最大值，但是要求必须min_doc_count不能大于0，不然即便是规定了边界，也不会返回。</p>
<ul>
<li>order排序</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;aggs&quot; : &#123;</div><div class="line">        &quot;prices&quot; : &#123;</div><div class="line">            &quot;histogram&quot; : &#123;</div><div class="line">                &quot;field&quot; : &quot;price&quot;,</div><div class="line">                &quot;interval&quot; : 50,</div><div class="line">                &quot;order&quot; : &#123; &quot;_key&quot; : &quot;desc&quot; &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="5-Date-Histogram聚合"><a href="#5-Date-Histogram聚合" class="headerlink" title="5. Date Histogram聚合"></a>5. Date Histogram聚合</h2><p>Date histogram的用法与histogram差不多，只不过区间上支持了日期的表达式。interval字段支持多种关键字：<code>year</code>, <code>quarter</code>, <code>month</code>, <code>week</code>, <code>day</code>, <code>hour</code>, <code>minute</code>, <code>second</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;aggs&quot;:&#123;</div><div class="line">        &quot;articles_over_time&quot;:&#123;</div><div class="line">            &quot;date_histogram&quot;:&#123;</div><div class="line">                &quot;field&quot;:&quot;date&quot;,</div><div class="line">                &quot;interval&quot;:&quot;1M&quot;,</div><div class="line">                &quot;format&quot;:&quot;yyyy-MM-dd&quot;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<ul>
<li>time_zone时区</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;aggs&quot;:&#123;</div><div class="line">        &quot;by_day&quot;:&#123;</div><div class="line">            &quot;date_histogram&quot;:&#123;</div><div class="line">                &quot;field&quot;:&quot;date&quot;,</div><div class="line">                &quot;interval&quot;:&quot;day&quot;,</div><div class="line">                &quot;time_zone&quot;:&quot;+08:00&quot;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>offset 使用偏移值，改变时间区间</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&#123;&quot;aggs&quot;:&#123;</div><div class="line">    &quot;by_day&quot;:&#123;</div><div class="line">        &quot;date_histogram&quot;:&#123;</div><div class="line">            &quot;field&quot;:&quot;date&quot;,</div><div class="line">            &quot;interval&quot;:&quot;day&quot;,</div><div class="line">            &quot;offset&quot;:&quot;+6h&quot;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="6-Range区间聚合"><a href="#6-Range区间聚合" class="headerlink" title="6. Range区间聚合"></a>6. Range区间聚合</h2><ul>
<li>聚合</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;aggs&quot;:&#123;</div><div class="line">        &quot;grade_ranges&quot;:&#123;</div><div class="line">            &quot;range&quot;:&#123;</div><div class="line">                &quot;field&quot;:&quot;grade&quot;,</div><div class="line">                &quot;ranges&quot;:[</div><div class="line">                    &#123;&quot;to&quot;:60&#125;,</div><div class="line">                    &#123;&quot;from&quot;:60,&quot;to&quot;:80&#125;,</div><div class="line">                    &#123;&quot;from&quot;:80&#125;]</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>聚合嵌套</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;aggs&quot;:&#123;</div><div class="line">        &quot;price_ranges&quot;:&#123;</div><div class="line">            &quot;range&quot;:&#123;</div><div class="line">                &quot;field&quot;:&quot;price&quot;,</div><div class="line">                &quot;ranges&quot;:[</div><div class="line">                    &#123;&quot;to&quot;:50&#125;,</div><div class="line">                    &#123;&quot;from&quot;:50,&quot;to&quot;:100&#125;,</div><div class="line">                    &#123;&quot;from&quot;:100&#125;</div><div class="line">                ]&#125;,</div><div class="line">                &quot;aggs&quot;:&#123;</div><div class="line">                    &quot;price_stats&quot;:&#123;</div><div class="line">                        &quot;stats&quot;:&#123;</div><div class="line">                            &quot;field&quot;:&quot;price&quot;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h2 id="7-DateRange日期范围聚合"><a href="#7-DateRange日期范围聚合" class="headerlink" title="7. DateRange日期范围聚合"></a>7. DateRange日期范围聚合</h2><p>相比于range聚合，date range就是范围可以由时间来指定。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;aggs&quot;:&#123;</div><div class="line">        &quot;range&quot;:&#123;</div><div class="line">            &quot;date_range&quot;:&#123;</div><div class="line">                &quot;field&quot;:&quot;date&quot;,</div><div class="line">                &quot;format&quot;:&quot;MM-yyy&quot;,</div><div class="line">                &quot;ranges&quot;:[</div><div class="line">                    &#123;&quot;to&quot;:&quot;now-10M/M&quot;&#125;,</div><div class="line">                    &#123;&quot;from&quot;:&quot;now-10M/M&quot;&#125;</div><div class="line">                ]</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="8-查询的种类"><a href="#8-查询的种类" class="headerlink" title="8. 查询的种类"></a>8. 查询的种类</h2><ul>
<li>Elasticsearch中的DSL主要由两部分组成：</li>
</ul>
<p>Leaf query Cluase 叶查询子句</p>
<p>这种查询可以单独使用，针对某一特定的字段查询特定的值，比如match、term、range等</p>
<p>Compound query Cluase 复合查询子句</p>
<p>这种查询配合其他的叶查询或者复合查询，用于在逻辑上，组成更为复杂的查询，比如bool</p>
<ul>
<li>Query与Filter</li>
</ul>
<p>查询在Query查询上下文和Filter过滤器上下文中，执行的操作是不一样的：</p>
<p>查询上下文：</p>
<p>在查询上下文中，查询会回答这个问题——“这个文档匹不匹配这个查询，它的相关度高么？”</p>
<p>如何验证匹配很好理解，如何计算相关度呢？之前说过，ES中索引的数据都会存储一个_score分值，分值越高就代表越匹配。另外关于某个搜索的分值计算还是很复杂的，因此也需要一定的时间。</p>
<p>查询上下文 是在 使用query进行查询时的执行环境，比如使用search的时候。</p>
<p>过滤器上下文：</p>
<p>在过滤器上下文中，查询会回答这个问题——“这个文档匹不匹配？”</p>
<p>答案很简单，是或者不是。它不会去计算任何分值，也不会关心返回的排序问题，因此效率会高一点。</p>
<p>过滤上下文 是在使用filter参数时候的执行环境，比如在bool查询中使用Must_not或者filter</p>
<h2 id="8-布尔查询Bool-Query"><a href="#8-布尔查询Bool-Query" class="headerlink" title="8. 布尔查询Bool Query"></a>8. 布尔查询Bool Query</h2><p>query的时候，会先比较查询条件，然后计算分值，最后返回文档结果；</p>
<p>而filter则是先判断是否满足查询条件，如果不满足，会缓存查询过程（记录该文档不满足结果）；满足的话，就直接缓存结果。</p>
<p>综上所述，filter快在两个方面：</p>
<p>1 对结果进行缓存</p>
<p>2 避免计算分值</p>
<p>bool查询也是采用more_matches_is_better的机制，因此满足must和should子句的文档将会合并起来计算分值。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;bool&quot; : &#123;</div><div class="line">        &quot;must&quot; : &#123;</div><div class="line">            &quot;term&quot; : &#123; &quot;user&quot; : &quot;kimchy&quot; &#125;</div><div class="line">        &#125;,</div><div class="line">        &quot;filter&quot;: &#123;</div><div class="line">            &quot;term&quot; : &#123; &quot;tag&quot; : &quot;tech&quot; &#125;</div><div class="line">        &#125;,</div><div class="line">        &quot;must_not&quot; : &#123;</div><div class="line">            &quot;range&quot; : &#123;</div><div class="line">                &quot;age&quot; : &#123; &quot;from&quot; : 10, &quot;to&quot; : 20 &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;,</div><div class="line">        &quot;should&quot; : [</div><div class="line">            &#123;</div><div class="line">                &quot;term&quot; : &#123; &quot;tag&quot; : &quot;wow&quot; &#125;</div><div class="line">            &#125;,</div><div class="line">            &#123;</div><div class="line">                &quot;term&quot; : &#123; &quot;tag&quot; : &quot;elasticsearch&quot; &#125;</div><div class="line">            &#125;</div><div class="line">        ],</div><div class="line">        &quot;minimum_should_match&quot; : 1,</div><div class="line">        &quot;boost&quot; : 1.0</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>使用named query给子句添加标记</li>
</ul>
<p>如果想知道到底是bool里面哪个条件匹配，可以使用named query查询：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;bool&quot; : &#123;</div><div class="line">        &quot;should&quot; : [</div><div class="line">            &#123;&quot;match&quot; : &#123; &quot;name.first&quot; : &#123;&quot;query&quot; : &quot;shay&quot;, &quot;_name&quot; : &quot;first&quot;&#125; &#125;&#125;,</div><div class="line">            &#123;&quot;match&quot; : &#123; &quot;name.last&quot; : &#123;&quot;query&quot; : &quot;banon&quot;, &quot;_name&quot; : &quot;last&quot;&#125; &#125;&#125;</div><div class="line">        ],</div><div class="line">        &quot;filter&quot; : &#123;</div><div class="line">            &quot;terms&quot; : &#123;</div><div class="line">                &quot;name.last&quot; : [&quot;banon&quot;, &quot;kimchy&quot;],</div><div class="line">                &quot;_name&quot; : &quot;test&quot;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></div></article></div></section><footer><div class="paginator"><a href="/2019/04/10/logstash-aggregate插件使用/" class="next"><button class="ui button teal">NEXT</button></a></div><div class="copyright"><p>© 2016 - 2019 <a href="http://yoursite.com">Rosy</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and theme by <a href="https://github.com/littlewin-wang/hexo-theme-casual" target="_blank">casual</a></p></div></footer></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script><script src="/js/jquery.goup.min.js"></script><script src="/js/semantic.min.js"></script><script src="/js/casual.js"></script><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>$(document).ready(function(){$.goup({trigger:100,bottomOffset:100,locationOffset:5,title:'',titleAsText:true});});</script><script>(function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){(w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);})(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');
_st('install','TvAnFS4AVxjiJUvrZJRB','2.0.0');</script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></div></body></html>