<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> logstash学习（二）—— 配置文件运行 | Rosy's</title><meta name="description" content="logstash学习（二）—— 配置文件运行 - Rosy"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/casual.css"><link rel="stylesheet" href="/css/semantic.min.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="Rosy's"></head><body><div class="sidebar"><div class="ui vertical inverted menu"><div class="h100"></div><h3 class="ui inverted aligned icon header"><div class="content"><a href="/" class="title-link">ROSY'S</a></div></h3><div class="h50"></div><div class="side-nav"><a href="/" target="_self" class="item">HOME<i class="icon home"></i></a><a href="/archives" target="_self" class="item">ARCHIVE<i class="icon archive"></i></a><a href="/tags" target="_self" class="item">TAGS<i class="icon tags"></i></a><a href="/about" target="_self" class="item">INFO<i class="icon info"></i></a><a href="/atom.xml" target="_self" class="item">RSS<i class="icon rss"></i></a></div><div class="item"><div class="ui inverted transparent icon input"><input type="text" placeholder="Search..." class="st-default-search-input"><i class="search icon"></i></div></div><div class="h50"></div></div><div class="h50 mq"><a class="ui teal big label"><i class="content icon"></i></a></div><div class="author-info"><a href="/" class="img-link"><img src="/me.jpeg" class="author-photo ui tiny circular image"></a><h4 class="ui aligned icon header"><div class="content">Rosy</div></h4><p class="author-desc">常常将自己分裂成三个人用于玩斗地主的双子女 | 热衷于烹饪 | 喜欢刘亦菲</p><div class="social-outer"><div class="social-inner"><a href="http://github.com/RanWX" target="_blank" class="social-link"><i class="icon github"></i></a><a href="http://weibo.com/u/2176147782?refer_flag=1005055010_&amp;is_all=1" target="_blank" class="social-link"><i class="icon weibo"></i></a></div></div></div></div><div class="main"><div class="wrap"><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">logstash学习（二）—— 配置文件运行</h1><div class="post-info"><div class="post-date"><h6 class="ui header"><i class="calendar icon"></i><div class="content">Apr 10, 2019</div></h6></div></div><div class="post-content"><p>在实际生产环境中，logstash常常需要用到复杂的运行规则，使用命令行显然不可取。所以可以自定义规则文件，然后让Logstash根据规则进行工作。</p>
<h2 id="1-配置文件"><a href="#1-配置文件" class="headerlink" title="1. 配置文件"></a>1. 配置文件</h2><p>配置文件结构如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">input&#123;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">filter&#123;</div><div class="line">    </div><div class="line">&#125;</div><div class="line"></div><div class="line">output&#123;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>配置文件主要有input，output和filter三个大的部分构成。input是数据的输入源，可以是来自文件，网站，redis，s3等。output是数据的输出，可以输出到文件，elasticsearch，邮件，kafka等。filter是过滤规则，根据需要进行内容的过滤。</p>
<p>将配置文件放在logstash下的config目录中。进入logstash的bin目录，运行配置文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># cd logstash-6.3.2/bin/</div><div class="line"># ./logstash -f /root/logstash-6.5.0/config/test.conf</div></pre></td></tr></table></figure>
<h2 id="2-常用插件"><a href="#2-常用插件" class="headerlink" title="2. 常用插件"></a>2. 常用插件</h2><p>例，如下的配置文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line">cat UGA-MTN.conf </div><div class="line">input &#123;</div><div class="line">  s3&#123;</div><div class="line">    access_key_id =&gt; &quot;ACCESS_KEY_ID&quot;</div><div class="line">    secret_access_key =&gt; &quot;SECRET_ACCESS_KEY&quot;</div><div class="line">    bucket =&gt; &quot;your_bucket&quot;</div><div class="line">    region =&gt; &quot;your_s3_region&quot;</div><div class="line">    interval =&gt; 600</div><div class="line">    prefix =&gt; &quot;……&quot; </div><div class="line">    exclude_pattern =&gt; &quot;……&quot;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">filter &#123;</div><div class="line">  urldecode&#123;</div><div class="line">    all_fields =&gt; true</div><div class="line">  &#125;</div><div class="line">  grok&#123;</div><div class="line">    match =&gt; &#123;&quot;message&quot; =&gt; &quot;%&#123;TIMESTAMP_ISO8601:log_date&#125;\s%&#123;NOTSPACE:log_name&#125;\s(?:%&#123;NOTSPACE:request_body&#125;)&quot;&#125;</div><div class="line">    remove_field =&gt; [&quot;log_name&quot;]</div><div class="line">  &#125;</div><div class="line">  json &#123;</div><div class="line">    source =&gt; &quot;request_body&quot;</div><div class="line">    remove_field =&gt; [&quot;request_body&quot;]</div><div class="line">  &#125;</div><div class="line">  mutate&#123;</div><div class="line">    add_field =&gt; &#123;</div><div class="line">      &quot;rack&quot; =&gt; &quot;……&quot;</div><div class="line">    &#125;</div><div class="line">    convert =&gt; &#123;</div><div class="line">      &quot;request_time&quot; =&gt; &quot;integer&quot;</div><div class="line">      &quot;status&quot; =&gt; &quot;integer&quot;</div><div class="line">      &quot;bytes_sent&quot; =&gt; &quot;integer&quot;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">output &#123;</div><div class="line">  elasticsearch &#123;</div><div class="line">    action =&gt; &quot;index&quot;                                       #The operation on ES</div><div class="line">    hosts =&gt; [&quot;192.168.32.20:9200&quot;]   #ElasticSearch host, can be array.</div><div class="line">    index =&gt; &quot;cache_log_%&#123;+YYYY.MM.dd&#125;&quot;                     #The index to write data to.</div><div class="line">    document_type =&gt; &quot;logs&quot;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="2-1-输入插件s3"><a href="#2-1-输入插件s3" class="headerlink" title="2.1 输入插件s3"></a>2.1 输入插件s3</h3><p>s3插件可以从s3上获取数据。常用参数有：</p>
<ul>
<li>access_key_id: String类型，没有默认值。用于获取s3的验证。</li>
<li>aws_credentials_file：String类型，没有默认值。用于获取s3的验证。当access_key_id和secret_access_key没有设置的时候，才会加载这个文件。</li>
<li>secret_access_key：String类型，默认值是“logstash”，根据实际情况进行修改。</li>
</ul>
<p>注：常用的获取s3验证的方法有：</p>
<ol>
<li>access_key_id和ecret_access_key进行配置；</li>
<li>配置aws_credentials_file从外部文件进行获取；</li>
<li>将AWS_ACCESS_KEY_ID和AWS_SECRET_ACCESS_KEY配置到环境变量中。</li>
<li>将AMAZON_ACCESS_KEY_ID和AMAZON_SECRET_ACCESS_KEY配置到环境变量中。</li>
<li>IAM实例的证书。</li>
</ol>
<ul>
<li>bucket，String类型必选参数且没有默认值。需要获取数据的s3的桶的名称。</li>
<li>region，String类型，默认值是“us-east-1”，表示AWS所在的位置区域。</li>
<li>interval，number类型，默认值是60，单位是秒。两次获取数据的间隔时间。</li>
<li>prefix，String类型，默认值是nil。表示表示在桶里面需要匹配的文件前缀，不是一个正则表达式。</li>
<li>exclude_pattern，String类型，默认值是nil。正则匹配需要从桶里面排除的文件。</li>
<li>temporary_directory，String类型，默认值是“/tmp/logstash”，用于临时保存从s3下载的文件，可以根据需求进行修改路径。</li>
</ul>
<p>其他参数详见官方文档：<a href="https://www.elastic.co/guide/en/logstash/current/plugins-inputs-s3.html" target="_blank" rel="external">s3插件说明</a></p>
<h3 id="2-2-输出插件elasticsearch"><a href="#2-2-输出插件elasticsearch" class="headerlink" title="2.2 输出插件elasticsearch"></a>2.2 输出插件elasticsearch</h3><p>elasticsearch只支持HTTP协议，logstash和elasticsearch的交互也优先使用HTTP协议。HTTP协议尽管稍微慢一点，但是很好控制和使用。</p>
<ul>
<li>action，，String类型，默认值是index。表示elasticsearch要进行的操作。有效操作有: index：为文件编索引；delete：根据id删除文件；create：为文件指定创建的索引，如果索引已经存在，则创建失败；update：根据id更新文件信息。</li>
<li>hosts，类型是Uri，默认值是[//127.0.0.1]。设置远程实例的主机，可以在数组里放多个ip设置多台主机。</li>
<li>index，String类型，默认值是logstash-%{+YYYY.MM.dd}。用于设置数据写入的index名称。</li>
</ul>
<p>其他参数详见官方文档：<a href="https://www.elastic.co/guide/en/logstash/current/plugins-outputs-elasticsearch.html" target="_blank" rel="external">elasticsearch插件说明</a></p>
<h3 id="2-3-filter插件"><a href="#2-3-filter插件" class="headerlink" title="2.3 filter插件"></a>2.3 filter插件</h3><ul>
<li>urldecode：Nginx作为反向代理服务器，部分日志在传输的过程中是通过“urlencoded”编码的，通过logstash收集上来的日志需要用urldecode将字符串还原为原来的格式。</li>
</ul>
<p>Urldecode常用的配置选项：</p>
<ol>
<li><p>all_fields：对所有的值进行url的解码，默认值为false</p>
</li>
<li><p>Charset：设置解码使用的字符集，默认为“utf-8”。</p>
</li>
</ol>
<ul>
<li>grok是通过系统预定义的正则表达式或者通过自己定义正则表达式来匹配日志中的各个值，在使用时自己可以根据自己的日志格式或者对匹配正则进行调整或者直接调用。如果，自己想在其他目录定义正则规则匹配日志，在使用时需要指定正则的路径。</li>
<li>mutate主要用来修改、替换、删除及重命名字段中的某些插件。</li>
</ul>
</div></article></div></section><footer><div class="paginator"><a href="/2019/04/10/logstash-aggregate插件使用/" class="next"><button class="ui button teal">NEXT</button></a></div><div class="copyright"><p>© 2016 - 2019 <a href="http://yoursite.com">Rosy</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and theme by <a href="https://github.com/littlewin-wang/hexo-theme-casual" target="_blank">casual</a></p></div></footer></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script><script src="/js/jquery.goup.min.js"></script><script src="/js/semantic.min.js"></script><script src="/js/casual.js"></script><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>$(document).ready(function(){$.goup({trigger:100,bottomOffset:100,locationOffset:5,title:'',titleAsText:true});});</script><script>(function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){(w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);})(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');
_st('install','TvAnFS4AVxjiJUvrZJRB','2.0.0');</script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></div></body></html>