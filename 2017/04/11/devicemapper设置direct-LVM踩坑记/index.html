<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> devicemapper设置direct-lvm踩坑记 | Rosy's</title><meta name="description" content="devicemapper设置direct-lvm踩坑记 - Rosy"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/casual.css"><link rel="stylesheet" href="/css/semantic.min.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="Rosy's"></head><body><div class="sidebar"><div class="ui vertical inverted menu"><div class="h100"></div><h3 class="ui inverted aligned icon header"><div class="content"><a href="/" class="title-link">ROSY'S</a></div></h3><div class="h50"></div><div class="side-nav"><a href="/" target="_self" class="item">HOME<i class="icon home"></i></a><a href="/archives" target="_self" class="item">ARCHIVE<i class="icon archive"></i></a><a href="/tags" target="_self" class="item">TAGS<i class="icon tags"></i></a><a href="/about" target="_self" class="item">INFO<i class="icon info"></i></a><a href="/atom.xml" target="_self" class="item">RSS<i class="icon rss"></i></a></div><div class="item"><div class="ui inverted transparent icon input"><input type="text" placeholder="Search..." class="st-default-search-input"><i class="search icon"></i></div></div><div class="h50"></div></div><div class="h50 mq"><a class="ui teal big label"><i class="content icon"></i></a></div><div class="author-info"><a href="/" class="img-link"><img src="/me.jpeg" class="author-photo ui tiny circular image"></a><h4 class="ui aligned icon header"><div class="content">Rosy</div></h4><p class="author-desc">常常将自己分裂成三个人用于玩斗地主的双子女 | 热衷于烹饪 | 喜欢刘亦菲</p><div class="social-outer"><div class="social-inner"><a href="http://github.com/RanWX" target="_blank" class="social-link"><i class="icon github"></i></a><a href="http://weibo.com/u/2176147782?refer_flag=1005055010_&amp;is_all=1" target="_blank" class="social-link"><i class="icon weibo"></i></a></div></div></div></div><div class="main"><div class="wrap"><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">devicemapper设置direct-lvm踩坑记</h1><div class="post-info"><div class="post-date"><h6 class="ui header"><i class="calendar icon"></i><div class="content">Apr 11, 2017</div></h6></div></div><div class="post-content"><p>这是一篇碎碎念，想到哪儿就写到哪儿。。<br>官网上说：<em>Docker hosts running the devicemapper storage driver default to a configuration mode known as loop-lvm. This mode uses sparse files to build the thin pool used by image and container snapshots. The mode is designed to work out-of-the-box with no additional configuration. However, production deployments should not run under loop-lvm mode.</em><br>所有的资料都说生产环境中建议用direct-lvm进行存储。网上说优点是便于扩容，备份和数据的迁移，还有的说性能更好。<br>扩容，备份和数据易迁移是使用外挂硬盘的优点，并不能解释为什么devicemapper用direct-lvm存储模式被官方强烈推荐。甚至在第一次启动docker的时候如果devicemapper不是用direct-lvm还会被警告：<br><em>WARNING: Usage of loopback devices is strongly discouraged for production use. Either use <code>–storage-opt dm.thinpooldev</code> or use <code>–storage-opt dm.no_warn_on_loop_devices=true</code> to suppress this warning.</em><br>性能好这个优点有一定道理，网上有人对此做过性能的测试<a href="http://blog.csdn.net/gushenbusi/article/details/49494629" target="_blank" rel="external">http://blog.csdn.net/gushenbusi/article/details/49494629</a>，得出结论“direct-lvm直接使用dm-thin内核模块，直接使用raw分区，在高负载和高密度下具有性能优势。”可能我没有在高负载高密度下使用docker的需求，所以使用direct-lvm的性能优势对我作用也不大。<br>在实际使用过程中碰到的问题是：在centos7.1下使用docker1.8.1，devicemapper的loop-lvm模式。某天发现容器的空间被占满了，于是便将文件清掉。然后发现了奇怪的情况：删除容器内的文件，宿主机并不会释放空间，容器空间依然是被占满的。在对精简池（thin pool），宿主机磁盘，和容器限制大小进行了改变，并在docker1.8.2和docker1.12.6下分别进行实验，发现有以下情况：<br> 在centos7.1下，docker1.8.2和1.12.6容器内文件的变化对宿主机存储空间的影响基本一致：</p>
<blockquote>
<ul>
<li>容器内内生成文件，再删除，宿主机不会释放空间，需要删除容器才会释放空间。</li>
<li>容器内生成文件，再删除，宿主机不会释放空间，再生成文件，宿主机重新可能会重新分配空间；也可能不会重新分配空间。</li>
<li>docker1.8.2下:<br>资源池预设空间小于宿主机磁盘大小，在容器中生成文件大于容器预设大小时，无法写入文件，但容器不会崩。<br>资源池预设空间大于宿主机磁盘大小，在容器中生成文件大于容器预设大小时，无法写入文件，但容器崩，退出后将无法再启动容器。<br>docker1.12.6下,当容器中生成文件大于容器预设大小时，无法写入文件，且容器崩溃。</li>
<li>当资源池和宿主机的预设空间大于宿主机空间，在容器中生成文件大于容器预设大小时，宿主机提示磁盘空间占满，docker1.8.2导致了宿主机崩溃，docker1.12.6则不会导致宿主机崩溃，但删除容器后不会释放空间，需要删除devicemapper文件夹。</li>
</ul>
</blockquote>
<p><a href="http://www.cnblogs.com/Andrew-XinFei/p/6245330.html" target="_blank" rel="external">http://www.cnblogs.com/Andrew-XinFei/p/6245330.html</a>这篇文章中提到：</p>
<blockquote>
<p>devicemapper + loop-lvm 还有一个缺陷，因为它是稀疏文件，所以它会不断增长。用户在使用过程中会注意到 /var/lib/docker/devicemapper/devicemapper/data 不断增长，而且无法控制。很多人会希望删除镜像或者可以解决这个问题，结果发现效果并不明显。原因就是这个稀疏文件的空间释放后基本不进行垃圾回收的问题。因此往往会出现即使删除了文件内容，空间却无法回收，随着使用这个稀疏文件一直在不断增长。所以:对于 CentOS/RHEL 的用户来说，在没有办法使用 UnionFS 的情况下，一定要配置 direct-lvm 给 devicemapper，无论是为了性能，稳定性还是空间利用率。</p>
</blockquote>
<p>感觉这段话是解决了上述问题。于是便千辛万苦申请了磁盘，设置之后发现情况并没有改变，删除文件磁盘依然不会释放空间，可能对上述文章理解有误吧，总之改成direct-lvm模式也没有解决我的问题。如果容器内有持续增长的文件，比如日志文件这种，撑爆容器是迟早的事情针对这种情况，目前想到的方法是将这些文件外挂到宿主机上，不知道还有没有别的方法。<br>上文说到千辛万苦挂磁盘，也想说一下。对于设置direct-lvm模式，官网讲得很清楚：<a href="https://docs.docker.com/engine/userguide/storagedriver/device-mapper-driver/#configure-docker-with-devicemapper" target="_blank" rel="external">https://docs.docker.com/engine/userguide/storagedriver/device-mapper-driver/#configure-docker-with-devicemapper</a>，过了英语四级的小伙伴就不要犯懒了。总之我犯了个懒，还用了百度，百度了中文安装方法。还是上述文章，里面的步骤写的很清楚，但是我运行老是报错，我的环境是centos7.3，docker1.12.6，出现的问题，在起容器的时候会有：<br><em>/usr/bin/docker-current: Error response from daemon: shim error: docker-runc not installed on system.</em><br>在给容器映射端口的时候有：<br><em>/usr/bin/docker-current: Error response from daemon: driver failed programming external connectivity on endpoint stoic_wright (35ded5c721d0ccde517d932e54c4062197a84252a72b951de4fd66fbe6f01d88): exec: “docker-proxy”: executable file not found in $PATH.</em><br>仔细对照官网，发现官网在添加direct-pool信息的时候，是将其直接写入配置文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">[root@localhost Desktop]# vi /usr/lib/systemd/system/docker.service</div><div class="line">[Service]</div><div class="line">Type=notify</div><div class="line">NotifyAccess=all</div><div class="line">EnvironmentFile=-/etc/sysconfig/docker</div><div class="line">EnvironmentFile=-/etc/sysconfig/docker-storage</div><div class="line">EnvironmentFile=-/etc/sysconfig/docker-network</div><div class="line">Environment=GOTRACEBACK=crash</div><div class="line">Environment=DOCKER_HTTP_HOST_COMPAT=1</div><div class="line">Environment=PATH=/usr/libexec/docker:/usr/bin:/usr/sbin</div><div class="line">ExecStart=/usr/bin/dockerd-current \</div><div class="line">          --add-runtime docker-runc=/usr/libexec/docker/docker-runc-current \</div><div class="line">          --default-runtime=docker-runc \</div><div class="line">          --exec-opt native.cgroupdriver=systemd \</div><div class="line">          --userland-proxy-path=/usr/libexec/docker/docker-proxy-current \</div><div class="line">          --storage-driver=devicemapper \</div><div class="line">          --storage-opt=dm.thinpooldev=/dev/mapper/docker-thinpool \</div><div class="line">          --storage-opt=dm.use_deferred_removal=true \</div><div class="line">          --storage-opt=dm.use_deferred_deletion=true</div><div class="line">          $OPTIONS \</div></pre></td></tr></table></figure></p>
<p>而上述文章采用了drop-in方法（官网也有提及），修改了daemon.conf和daemon.json<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">[root@srv00 ~]# mkdir /etc/systemd/system/docker.service.d</div><div class="line">[root@srv00 ~]# vi /etc/systemd/system/docker.service.d/daemon.conf</div><div class="line">[Service]</div><div class="line">ExecStart=</div><div class="line">ExecStart=/usr/bin/dockerd</div><div class="line">[root@srv00 ~]# vi /etc/docker/daemon.json</div><div class="line">&#123;</div><div class="line">  &quot;storage-driver&quot;: &quot;devicemapper&quot;,</div><div class="line">   &quot;storage-opts&quot;: [</div><div class="line">     &quot;dm.thinpooldev=/dev/mapper/vgdocker-thinpool&quot;,</div><div class="line">     &quot;dm.use_deferred_removal=true&quot;,</div><div class="line">     &quot;dm.use_deferred_deletion=true&quot;</div><div class="line">   ]</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>不同在于ExecStart，原始配置文件启动的是<em>/usr/bin/dockerd-current</em>，而drop-in的方法启动的是<em>/usr/bin/dockerd</em>。<br>进入<em>/usr/libexec/docker/</em>文件夹，确实没有<em>docker-runc</em>和<em>docker-proxy</em>存在，有的是<em>docker-runc-current</em>和<em>docker-proxy-current</em>。加上两个软连接，问题解决：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># cd /usr/libexec/docker/ </div><div class="line"># sudo ln -s docker-runc-current docker-runc</div><div class="line"># sudo ln -s docker-proxy-current docker-proxy</div></pre></td></tr></table></figure>
<p>使用配置文件本来是件好事，比如修改配置不必重启服务，只需发送SIGHUP信号即可。<br>但是目前在dockerd中使用配置文件会有一些问题：例如无法得知具体哪项生效了，启动日志以及docker info，还有ps -ef都不会给出生效配置，这对于排障很不方便。<br>当 dockerd的参数和daemon.json文件中的配置有所重复或者冲突，会直接导致引擎启动失败。<strong>因此在这些问题解决前，先使用修改docker.service这类做法来实现。</strong><br><a href="https://blog.lab99.org/post/docker-2016-07-14-faq.html" target="_blank" rel="external">https://blog.lab99.org/post/docker-2016-07-14-faq.html</a>这篇文章解决了我的很多疑惑，对初学者很有意义。</p>
</div></article></div></section><footer><div class="paginator"><a href="/2017/07/18/swagger常用注解记录/" class="prev"><button class="ui button teal">PREV</button></a><a href="/2017/03/01/搭建docker私有仓库并进行用户认证/" class="next"><button class="ui button teal">NEXT</button></a></div><div class="copyright"><p>© 2016 - 2020 <a href="http://yoursite.com">Rosy</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and theme by <a href="https://github.com/littlewin-wang/hexo-theme-casual" target="_blank">casual</a></p></div></footer></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script><script src="/js/jquery.goup.min.js"></script><script src="/js/semantic.min.js"></script><script src="/js/casual.js"></script><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>$(document).ready(function(){$.goup({trigger:100,bottomOffset:100,locationOffset:5,title:'',titleAsText:true});});</script><script>(function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){(w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);})(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');
_st('install','TvAnFS4AVxjiJUvrZJRB','2.0.0');</script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></div></body></html>