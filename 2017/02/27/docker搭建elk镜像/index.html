<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> docker搭建elk镜像 | Rosy's</title><meta name="description" content="docker搭建elk镜像 - Rosy"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/casual.css"><link rel="stylesheet" href="/css/semantic.min.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="Rosy's"></head><body><div class="sidebar"><div class="ui vertical inverted menu"><div class="h100"></div><h3 class="ui inverted aligned icon header"><div class="content"><a href="/" class="title-link">ROSY'S</a></div></h3><div class="h50"></div><div class="side-nav"><a href="/" target="_self" class="item">HOME<i class="icon home"></i></a><a href="/archives" target="_self" class="item">ARCHIVE<i class="icon archive"></i></a><a href="/tags" target="_self" class="item">TAGS<i class="icon tags"></i></a><a href="/about" target="_self" class="item">INFO<i class="icon info"></i></a><a href="/atom.xml" target="_self" class="item">RSS<i class="icon rss"></i></a></div><div class="item"><div class="ui inverted transparent icon input"><input type="text" placeholder="Search..." class="st-default-search-input"><i class="search icon"></i></div></div><div class="h50"></div></div><div class="h50 mq"><a class="ui teal big label"><i class="content icon"></i></a></div><div class="author-info"><a href="/" class="img-link"><img src="/me.jpeg" class="author-photo ui tiny circular image"></a><h4 class="ui aligned icon header"><div class="content">Rosy</div></h4><p class="author-desc">常常将自己分裂成三个人用于玩斗地主的双子女 | 热衷于烹饪 | 喜欢刘亦菲</p><div class="social-outer"><div class="social-inner"><a href="http://github.com/RanWX" target="_blank" class="social-link"><i class="icon github"></i></a><a href="http://weibo.com/u/2176147782?refer_flag=1005055010_&amp;is_all=1" target="_blank" class="social-link"><i class="icon weibo"></i></a></div></div></div></div><div class="main"><div class="wrap"><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">docker搭建elk镜像</h1><div class="post-info"><div class="post-date"><h6 class="ui header"><i class="calendar icon"></i><div class="content">Feb 27, 2017</div></h6></div></div><div class="post-content"><p>使用elk(elasticsearch+logstash+kibana)不需要openssh，搭建openssh是为了方便往elasticsearch里添加数据。</p>
<p><strong>因为安装过程用到了service，亲测centos7的基础镜像不能用。用service起的命令可以手动起，也可以安装centos7.2版本，然后用 <em>–privileged</em> 赋予容器root权限</strong></p>
<h2 id="1-安装openssh"><a href="#1-安装openssh" class="headerlink" title="1.安装openssh"></a>1.安装openssh</h2><h3 id="1-1创建容器"><a href="#1-1创建容器" class="headerlink" title="1.1创建容器"></a>1.1创建容器</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">rosyMacBook-Pro:~ rosy$ docker run -tid --privileged yasanbee/centos7.2-systemd /bin/bash</div><div class="line">a435707cf766d50b517b61ffb74b86539bb0ce208965af566ee5e688726b041f</div><div class="line">rosyMacBook-Pro:~ rosy$ docker ps -a</div><div class="line">CONTAINER ID        IMAGE                        COMMAND                  CREATED             STATUS                    PORTS                     NAMES</div><div class="line">a435707cf766        yasanbee/centos7.2-systemd   &quot;/usr/sbin/init /bin/&quot;   5 seconds ago       Up 4 seconds                                        hungry_darwin</div></pre></td></tr></table></figure>
<p>进入容器，如果启动的时候就进入，亲测会出现无法退出的问题，所以建议先创建后进入容器。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">rosyMacBook-Pro:~ rosy$ docker exec -ti a435 /bin/bash</div></pre></td></tr></table></figure>
<h3 id="1-2安装passwd"><a href="#1-2安装passwd" class="headerlink" title="1.2安装passwd"></a>1.2安装passwd</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@a435707cf766 /]# yum install passwd -y</div></pre></td></tr></table></figure>
<h3 id="1-3修改centos密码"><a href="#1-3修改centos密码" class="headerlink" title="1.3修改centos密码"></a>1.3修改centos密码</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@a435707cf766 /]# passwd</div><div class="line">Changing password for user root.</div><div class="line">New password: #此处输入密码并记住它，ssh连接需要</div><div class="line">BAD PASSWORD: The password is shorter than 8 characters</div><div class="line">Retype new password: </div><div class="line">passwd: all authentication tokens updated successfully.</div></pre></td></tr></table></figure>
<h3 id="1-4安装openssh"><a href="#1-4安装openssh" class="headerlink" title="1.4安装openssh"></a>1.4安装openssh</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@a435707cf766 /]# yum install openssh-server -y</div></pre></td></tr></table></figure>
<h3 id="1-5生成公钥、私钥"><a href="#1-5生成公钥、私钥" class="headerlink" title="1.5生成公钥、私钥"></a>1.5生成公钥、私钥</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line">[root@a435707cf766 /]# ssh-keygen -t rsa -f /etc/ssh/ssh_host_rsa_key</div><div class="line">Generating public/private rsa key pair.</div><div class="line">Enter passphrase (empty for no passphrase): #回车</div><div class="line">Enter same passphrase again: #回车</div><div class="line">Your identification has been saved in /etc/ssh/ssh_host_rsa_key.</div><div class="line">Your public key has been saved in /etc/ssh/ssh_host_rsa_key.pub.</div><div class="line">The key fingerprint is:</div><div class="line">f7:eb:32:e9:26:6a:ec:82:e7:0d:ae:2e:1a:61:38:f7 root@a435707cf766</div><div class="line">The key&apos;s randomart image is:</div><div class="line">+--[ RSA 2048]----+</div><div class="line">|                 |</div><div class="line">|                 |</div><div class="line">|                 |</div><div class="line">|.                |</div><div class="line">|+..     S .      |</div><div class="line">|.+ .     . .     |</div><div class="line">|.  .E.     ..    |</div><div class="line">|....ooo . =  .   |</div><div class="line">|ooo+o++. +.+o    |</div><div class="line">+-----------------+</div><div class="line">[root@a435707cf766 /]# ssh-keygen -t rsa -f /etc/ssh/ssh_host_ecdsa_key</div><div class="line">Generating public/private rsa key pair.</div><div class="line">Enter passphrase (empty for no passphrase): #回车</div><div class="line">Enter same passphrase again: #回车</div><div class="line">Your identification has been saved in /etc/ssh/ssh_host_ecdsa_key.</div><div class="line">Your public key has been saved in /etc/ssh/ssh_host_ecdsa_key.pub.</div><div class="line">The key fingerprint is:</div><div class="line">62:d8:41:ed:de:8f:26:4d:61:3b:66:37:d7:3e:7c:3f root@a435707cf766</div><div class="line">The key&apos;s randomart image is:</div><div class="line">+--[ RSA 2048]----+</div><div class="line">|      ..         |</div><div class="line">|     .  .        |</div><div class="line">|      ..         |</div><div class="line">|     o .. o      |</div><div class="line">|    . +.So o   . |</div><div class="line">|     . .. B o . .|</div><div class="line">|         = = o.. |</div><div class="line">|        . + .  Eo|</div><div class="line">|         o      *|</div><div class="line">+-----------------+</div><div class="line">[root@a435707cf766 /]# ssh-keygen -t rsa -f /etc/ssh/ssh_host_ed25519_key</div><div class="line">Generating public/private rsa key pair.</div><div class="line">Enter passphrase (empty for no passphrase): #回车</div><div class="line">Enter same passphrase again: #回车</div><div class="line">Your identification has been saved in /etc/ssh/ssh_host_ed25519_key.</div><div class="line">Your public key has been saved in /etc/ssh/ssh_host_ed25519_key.pub.</div><div class="line">The key fingerprint is:</div><div class="line">cb:6f:98:dc:b0:65:83:dd:d0:aa:25:c1:c2:ab:cb:7d root@a435707cf766</div><div class="line">The key&apos;s randomart image is:</div><div class="line">+--[ RSA 2048]----+</div><div class="line">|                 |</div><div class="line">|                 |</div><div class="line">|     . .   .     |</div><div class="line">|      o o . .    |</div><div class="line">|       oS+ +     |</div><div class="line">|      ..+.B .    |</div><div class="line">|     . .o% .     |</div><div class="line">|   ...  E.o      |</div><div class="line">|    o... ..      |</div><div class="line">+-----------------+</div></pre></td></tr></table></figure>
<h3 id="1-6编写启动脚本"><a href="#1-6编写启动脚本" class="headerlink" title="1.6编写启动脚本"></a>1.6编写启动脚本</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@a435707cf766 /]# vi /run.sh</div><div class="line">#!/bin/bash</div><div class="line">/usr/sbin/sshd -D</div><div class="line">[root@a435707cf766 /]# chmod +x /run.sh</div></pre></td></tr></table></figure>
<h3 id="1-7修改SSH默认端口"><a href="#1-7修改SSH默认端口" class="headerlink" title="1.7修改SSH默认端口"></a>1.7修改SSH默认端口</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@a435707cf766 /]# vi /etc/ssh/sshd_config </div><div class="line">Port 222</div></pre></td></tr></table></figure>
<h3 id="1-8退出容器并将其保存为镜像"><a href="#1-8退出容器并将其保存为镜像" class="headerlink" title="1.8退出容器并将其保存为镜像"></a>1.8退出容器并将其保存为镜像</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">rosyMacBook-Pro:~ rosy$ docker commit a435 sshd_centos7.2:centos7.2 </div><div class="line">sha256:8857ac6591c67e1a573a51faace20e958f148730ffe2e7ac49d26272cded8a51</div><div class="line">rosyMacBook-Pro:~ rosy$ docker images</div><div class="line">REPOSITORY                   TAG                 IMAGE ID            CREATED             SIZE</div><div class="line">sshd_centos7.2               centos7.2           8857ac6591c6        25 seconds ago      427.7 MB</div></pre></td></tr></table></figure>
<h2 id="2-搭建elk"><a href="#2-搭建elk" class="headerlink" title="2.搭建elk"></a>2.搭建elk</h2><p>添加数据和展示数据用elasticsearch和kibana就足够了，暂时用不到logstash，可以需要的时候再添加。<br>用各种方法，将elk.zip放进容器里面。可以外挂数据卷，外挂数据卷容器等，这里采用另起终端开了个服务器，再在容器里进行下载的方法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">rosyMacBook-Pro:~ rosy$ python -m SimpleHTTPServer 8080</div></pre></td></tr></table></figure></p>
<p>在容器里面下载并保存在/root/下面：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@39e9e27c9863 /]# curl -o /root/elk.zip 192.168.234.52:8080/elk.zip</div></pre></td></tr></table></figure></p>
<p>将elk.zip解压缩，如果容器里面没有unzip命令，需要安装：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@39e9e27c9863 /]# yum install unzip </div><div class="line">[root@39e9e27c9863 ~]# unzip /root/elk.zip</div><div class="line">[root@39e9e27c9863 ~]# cd /root/elk</div><div class="line">[root@39e9e27c9863 elk]# ls</div><div class="line">elasticsearch-1.7.3.noarch.rpm  kibana-4.1.2-linux-x64.tar.gz  logstash-1.5.4-1.noarch.rpm  logstash-forwarder-0.4.0-1.x86_64.rpm</div></pre></td></tr></table></figure></p>
<h3 id="2-1安装环境和安装包"><a href="#2-1安装环境和安装包" class="headerlink" title="2.1安装环境和安装包"></a>2.1安装环境和安装包</h3><h4 id="2-1-1安装环境"><a href="#2-1-1安装环境" class="headerlink" title="2.1.1安装环境"></a>2.1.1安装环境</h4><blockquote>
<ul>
<li>OS：Centos7.1</li>
<li>jdk1.7</li>
</ul>
</blockquote>
<h4 id="2-1-2安装包"><a href="#2-1-2安装包" class="headerlink" title="2.1.2安装包"></a>2.1.2安装包</h4><blockquote>
<ul>
<li>elasticsearch-1.7.3.noarch.rpm </li>
<li>kibana-4.1.2-linux-x64.tar.gz     </li>
</ul>
</blockquote>
<h4 id="2-1-2创建容器"><a href="#2-1-2创建容器" class="headerlink" title="2.1.2创建容器"></a>2.1.2创建容器</h4><p>基于我们生产的sshd镜像创建容器。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">rosyMacBook-Pro:~ rosy$ docker run -tid --privileged sshd_centos7.2:centos7.2 /bin/bash</div><div class="line">39e9e27c98630d10461621e71d12074a91d0d4a7a69f836a5155cd3a84493d30</div><div class="line">rosyMacBook-Pro:~ rosy$ docker exec -ti 39e9e /bin/bash</div></pre></td></tr></table></figure></p>
<p>也可以点击<a href="http://39.105.210.20:8888/blog_appendix/elk.zip" target="_blank" rel="external">elk.zip</a>下载相关安装包</p>
<h3 id="2-2安装jdk1-7"><a href="#2-2安装jdk1-7" class="headerlink" title="2.2安装jdk1.7"></a>2.2安装jdk1.7</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@39e9e27c9863 /]# yum install java-1.7.0-openjdk</div></pre></td></tr></table></figure>
<h3 id="2-3安装elasticsearch"><a href="#2-3安装elasticsearch" class="headerlink" title="2.3安装elasticsearch"></a>2.3安装elasticsearch</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">[root@39e9e27c9863 ~]# cd /root/elk</div><div class="line">[root@39e9e27c9863 elk]# yum localinstall elasticsearch-1.7.3.noarch.rpm</div><div class="line">[root@39e9e27c9863 elk]# systemctl daemon-reload </div><div class="line">[root@39e9e27c9863 elk]# systemctl enable elasticsearch.service (设置开机自启动)</div><div class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/elasticsearch.service to /usr/lib/systemd/system/elasticsearch.service.</div><div class="line">[root@39e9e27c9863 elk]# systemctl start elasticsearch.service (开启服务)</div><div class="line">[root@39e9e27c9863 elk]# systemctl status elasticsearch.service (查询服务状态)</div><div class="line">● elasticsearch.service - Elasticsearch</div><div class="line">   Loaded: loaded (/usr/lib/systemd/system/elasticsearch.service; enabled; vendor preset: disabled)</div><div class="line">   Active: active (running) since Mon 2017-02-27 12:09:14 UTC; 9s ago</div><div class="line">     Docs: http://www.elastic.co</div><div class="line"> Main PID: 271 (java)</div><div class="line">   CGroup: /docker/39e9e27c98630d10461621e71d12074a91d0d4a7a69f836a5155cd3a84493d30/system.slice/elasticsearch.service</div><div class="line">           └─271 java -Xms256m -Xmx1g -Djava.awt.headless=true -XX:+UseParNewGC -XX:+UseConcMarkSweepGC -XX:CMSInitiatingOccupancyFraction=75 -XX:+UseCMSInitiatingOccupa...</div><div class="line">Feb 27 12:09:14 39e9e27c9863 systemd[1]: Started Elasticsearch.</div><div class="line">Feb 27 12:09:14 39e9e27c9863 systemd[1]: Starting Elasticsearch...</div></pre></td></tr></table></figure>
<p>查看服务状态，看到服务在运行，则证明elasticsearch安装完成，对外提供服务的端口为9200。</p>
<h3 id="2-4安装kibana"><a href="#2-4安装kibana" class="headerlink" title="2.4安装kibana"></a>2.4安装kibana</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@39e9e27c9863 elk]# tar zxf /root/elk/kibana-4.1.2-linux-x64.tar.gz -C /usr/local/ </div><div class="line">[root@39e9e27c9863 elk]# cd /usr/local/</div><div class="line">[root@39e9e27c9863 local]# mv kibana-4.1.2-linux-x64/ kibana</div><div class="line">[root@39e9e27c9863 local]# cd /usr/local/kibana/bin</div><div class="line">[root@39e9e27c9863 bin]# ls</div><div class="line">kibana  kibana.bat</div></pre></td></tr></table></figure>
<p>此时运行<em>./kibana</em>即可开启，将启动kibana写到service里面：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">[root@39e9e27c9863 local]# vi /etc/systemd/system/kibana.service</div><div class="line"></div><div class="line">[Service]</div><div class="line">ExecStart=/usr/local/kibana/bin/kibana</div><div class="line"></div><div class="line">[Install]</div><div class="line">WantedBy=multi-user.target</div><div class="line">[root@39e9e27c9863 bin]# systemctl enable kibana.service</div><div class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/kibana.service to /etc/systemd/system/kibana.service.</div><div class="line">[root@39e9e27c9863 bin]# systemctl start kibana.service</div><div class="line">[root@39e9e27c9863 bin]# systemctl status kibana.service </div><div class="line">● kibana.service</div><div class="line">   Loaded: loaded (/etc/systemd/system/kibana.service; enabled; vendor preset: disabled)</div><div class="line">   Active: active (running) since Mon 2017-02-27 12:22:18 UTC; 7s ago</div><div class="line"> Main PID: 348 (node)</div><div class="line">   CGroup: /docker/39e9e27c98630d10461621e71d12074a91d0d4a7a69f836a5155cd3a84493d30/system.slice/kibana.service</div><div class="line">           └─348 /usr/local/kibana/bin/../node/bin/node /usr/local/kibana/bin/../src/bin/kibana.js</div><div class="line"></div><div class="line">Feb 27 12:22:18 39e9e27c9863 systemd[1]: Started kibana.service.</div><div class="line">Feb 27 12:22:18 39e9e27c9863 systemd[1]: Starting kibana.service...</div><div class="line">Feb 27 12:22:23 39e9e27c9863 kibana[348]: &#123;&quot;name&quot;:&quot;Kibana&quot;,&quot;hostname&quot;:&quot;39e9e27c9863&quot;,&quot;pid&quot;:348,&quot;level&quot;:30,&quot;msg&quot;:&quot;No existing kibana index found&quot;,&quot;time&quot;:&quot;2017-0...3Z&quot;,&quot;v&quot;:0&#125;</div><div class="line">Feb 27 12:22:23 39e9e27c9863 kibana[348]: &#123;&quot;name&quot;:&quot;Kibana&quot;,&quot;hostname&quot;:&quot;39e9e27c9863&quot;,&quot;pid&quot;:348,&quot;level&quot;:30,&quot;msg&quot;:&quot;Listening on 0.0.0.0:5601&quot;,&quot;time&quot;:&quot;2017-02-27T...9Z&quot;,&quot;v&quot;:0&#125;</div><div class="line">Hint: Some lines were ellipsized, use -l to show in full.</div></pre></td></tr></table></figure></p>
<p>查看服务状态，看到服务在运行，则证明kibana安装完成，kibana对外提供服务的端口为5601。</p>
<h3 id="2-5退出容器并将其保存为镜像"><a href="#2-5退出容器并将其保存为镜像" class="headerlink" title="2.5退出容器并将其保存为镜像"></a>2.5退出容器并将其保存为镜像</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">rosyMacBook-Pro:~ rosy$ docker ps -a</div><div class="line">CONTAINER ID        IMAGE                        COMMAND                  CREATED             STATUS                    PORTS                     NAMES</div><div class="line">39e9e27c9863        sshd_centos7.2:centos7.2     &quot;/usr/sbin/init /bin/&quot;   3 hours ago         Up About an hour                                    ecstatic_liskov</div><div class="line">rosyMacBook-Pro:~ rosy$ docker commit 39e9e elk:sshd_centos7.2</div><div class="line">sha256:fe5366107fa2ddc79edc3a73091ef78789f3d28ecb8b2d88884ce69cb13511be</div><div class="line">rosyMacBook-Pro:~ rosy$ docker images</div><div class="line">REPOSITORY                   TAG                 IMAGE ID            CREATED             SIZE</div><div class="line">elk                          sshd_centos7.2      fe5366107fa2        11 seconds ago      1.027 GB</div></pre></td></tr></table></figure>
<h2 id="3-验证elk镜像"><a href="#3-验证elk镜像" class="headerlink" title="3.验证elk镜像"></a>3.验证elk镜像</h2><h3 id="3-1验证kibana"><a href="#3-1验证kibana" class="headerlink" title="3.1验证kibana"></a>3.1验证kibana</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">rosyMacBook-Pro:~ rosy$ docker run -tid --privileged -p 5050:5601 -p 223:222 --name elk_test elk:sshd_centos7.2 /run.sh</div><div class="line">d2db917f76f5e176a2bec7fb2ce19c74078d22ba567395406b092171f174bb7b</div></pre></td></tr></table></figure>
<p>打开浏览器，输入ip地址和对外映射的端口5050，可以访问kibana的网页：<br><img src="http://39.105.210.20:8888/blog_pic/new_5.png" alt="kibana"><br>则基于elk的镜像搭建成功。<br><strong>如果不是在本机上进行的访问，则需要注意关闭防火墙或者开启相应的端口。</strong><br>关闭防火墙方法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">rosyMacBook-Pro:~ rosy$ systemctl disable firewalld.service</div><div class="line">rosyMacBook-Pro:~ rosy$ systemctl stop firewalld.service</div></pre></td></tr></table></figure></p>
<p>防火墙开启端口：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">rosyMacBook-Pro:~ rosy$ firewall-cmd --permanent --add-port=5601/tcp    （防火墙开启5601端口）</div><div class="line">success</div><div class="line">rosyMacBook-Pro:~ rosy$ firewall-cmd --reload    （重载防火墙）</div><div class="line">success</div></pre></td></tr></table></figure></p>
<h3 id="3-2验证ssh"><a href="#3-2验证ssh" class="headerlink" title="3.2验证ssh"></a>3.2验证ssh</h3><p>远程ssh登录，启动容器对外映射的端口为223。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">rosyMacBook-Pro:~ rosy$ sudo ssh 192.168.234.52 -p 223</div><div class="line">Password:</div><div class="line">The authenticity of host &apos;[192.168.234.52]:223 ([192.168.234.52]:223)&apos; can&apos;t be established.</div><div class="line">RSA key fingerprint is f7:eb:32:e9:26:6a:ec:82:e7:0d:ae:2e:1a:61:38:f7.</div><div class="line">Are you sure you want to continue connecting (yes/no)? yes</div><div class="line">Warning: Permanently added &apos;[192.168.234.52]:223&apos; (RSA) to the list of known hosts.</div><div class="line">root@192.168.234.52&apos;s password: </div><div class="line">System is booting up. See pam_nologin(8)</div><div class="line">[root@d2db917f76f5 ~]# ls</div><div class="line">anaconda-ks.cfg  elk  elk.zip</div></pre></td></tr></table></figure></p>
<p>ssh成功连接容器。</p>
<h3 id="3-3验证elasticsearch"><a href="#3-3验证elasticsearch" class="headerlink" title="3.3验证elasticsearch"></a>3.3验证elasticsearch</h3><p>在容器中添加一条数据，ssh连接或者进入容器均可<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@d2db917f76f5 ~]# curl -XPUT &apos;http://localhost:9200/twitter/tweet/1&apos; -d &apos;&#123;</div><div class="line">    &quot;user&quot; : &quot;kimchy&quot;,</div><div class="line">    &quot;post_date&quot; : &quot;2017-1-15T14:12:12&quot;,</div><div class="line">    &quot;message&quot; : &quot;trying out Elasticsearch&quot;</div><div class="line">&#125;&apos;</div><div class="line">&#123;&quot;_index&quot;:&quot;twitter&quot;,&quot;_type&quot;:&quot;tweet&quot;,&quot;_id&quot;:&quot;1&quot;,&quot;_version&quot;:1,&quot;created&quot;:true&#125;[root@d2db917f76f5 ~]# </div><div class="line">[root@d2db917f76f5 ~]#</div></pre></td></tr></table></figure></p>
<p>在网页中打开kibana，在setting中选择关键字“twitter”可以看见我们添加的数据：<br><img src="http://39.105.210.20:8888/blog_pic/new_6.png" alt="twitter"></p>
<p>至此，elk的镜像便搭好了，至于elasticsearch和kibana的用法，会另起一篇叨叨。</p>
<p>本文参考了以下博客：<br>1.<a href="http://www.cnblogs.com/zhenyuyaodidiao/p/4948000.html" target="_blank" rel="external">http://www.cnblogs.com/zhenyuyaodidiao/p/4948000.html</a><br>2.<a href="http://www.cnblogs.com/zhenyuyaodidiao/p/4512249.html" target="_blank" rel="external">http://www.cnblogs.com/zhenyuyaodidiao/p/4512249.html</a></p>
</div></article></div></section><footer><div class="paginator"><a href="/2017/03/01/搭建docker私有仓库并进行用户认证/" class="prev"><button class="ui button teal">上一篇</button></a><a href="/2017/02/15/mtr丢包率分析/" class="next"><button class="ui button teal">下一篇</button></a></div><div class="copyright"><p>© 2016 - 2019 <a href="http://yoursite.com">Rosy</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and theme by <a href="https://github.com/littlewin-wang/hexo-theme-casual" target="_blank">casual</a></p></div></footer></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script><script src="/js/jquery.goup.min.js"></script><script src="/js/semantic.min.js"></script><script src="/js/casual.js"></script><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>$(document).ready(function(){$.goup({trigger:100,bottomOffset:100,locationOffset:5,title:'',titleAsText:true});});</script><script>(function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){(w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);})(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');
_st('install','TvAnFS4AVxjiJUvrZJRB','2.0.0');</script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></div></body></html>